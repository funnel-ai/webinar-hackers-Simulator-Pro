<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webinar Hackers Simulator</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Embedded CSS -->
    <style>
        :root {
            /* Primary Colors */
            --primary-purple: #6a11cb; /* Deep purple */
            --secondary-blue: #2575fc; /* Bright blue */
            --accent-purple: #7e57c2; /* Lighter purple for accents */
            --accent-teal: #26a69a;  /* Teal for products button */

            /* UI Colors */
            --sidebar-bg: #f8f9fa;
            --content-bg: #ffffff;
            --input-bg: #f1f3f7; /* Light gray for inputs */
            --card-bg: #ffffff;
            --border-color: #dee2e6;
            --text-color: #212529;
            --text-muted: #6c757d;
            --light-yellow-bg: #fffbeb; /* For Profit/ROI cards */
            --dream-profit-header: #ffab40; /* Orange */

            /* Feedback Colors */
            --positive-color: #198754; /* Green */
            --negative-color: #dc3545; /* Red */

            /* Dark Mode Colors */
            --dark-bg: #121212; /* Darker main background */
            --dark-sidebar-bg: #1e1e1e;
            --dark-content-bg: #1e1e1e; /* Content same as sidebar for less contrast */
            --dark-card-bg: #2c2c2c;
            --dark-input-bg: #3a3a3a;
            --dark-text-color: #e0e0e0;
            --dark-text-muted: #adb5bd;
            --dark-border-color: #444;
            --dark-light-yellow-bg: #4d442b;
            --dark-positive-color: #20c997; /* Brighter green */
            --dark-negative-color: #f17c86; /* Lighter red */
            --dark-dream-profit-header: #b8792e; /* Darker Orange */

            --navbar-height: 60px;
            --sidebar-width: 300px;
        }

        body {
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            background-color: var(--content-bg);
            color: var(--text-color);
            padding-top: var(--navbar-height);
            padding-left: var(--sidebar-width);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* --- Navbar --- */
        .navbar {
            background: linear-gradient(90deg, var(--primary-purple) 0%, var(--accent-purple) 100%);
            height: var(--navbar-height);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            width: 100%;
            z-index: 1030;
            padding: 0 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .navbar-brand {
            color: #fff !important;
            font-weight: 600;
            font-size: 1.1rem;
        }
         .navbar .nav-link,
         .navbar .navbar-text,
         .navbar .btn-light {
             color: rgba(255, 255, 255, 0.9) !important;
             font-size: 0.9rem;
         }
         .navbar .btn {
             margin-left: 0.5rem;
             background-color: rgba(255, 255, 255, 0.1);
             border: 1px solid rgba(255, 255, 255, 0.2);
             color: #fff;
             padding: 0.25rem 0.75rem;
             font-size: 0.85rem;
         }
         .navbar .btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
            color: #fff;
         }
        .navbar .form-check-label {
             color: rgba(255, 255, 255, 0.8);
        }
         .navbar .form-check-input:checked {
            background-color: var(--secondary-blue);
            border-color: var(--primary-purple);
        }

        /* --- Sidebar --- */
        #sidebar {
            position: fixed;
            top: var(--navbar-height);
            left: 0;
            width: var(--sidebar-width);
            height: calc(100vh - var(--navbar-height));
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            padding: 1.5rem 1.25rem;
            overflow-y: auto;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            z-index: 1020;
        }
        #sidebar h5 {
            color: var(--primary-purple);
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }
         #sidebar h5:first-child {
            margin-top: 0;
         }
        #sidebar .form-label {
            font-size: 0.8rem;
            margin-bottom: 0.25rem;
            color: var(--text-muted);
            font-weight: 500;
        }
        #sidebar .form-control,
        #sidebar .form-select {
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
        }
        #sidebar .form-control:focus,
        #sidebar .form-select:focus {
             background-color: var(--card-bg);
             border-color: var(--primary-purple);
             box-shadow: 0 0 0 0.2rem rgba(106, 17, 203, 0.25);
         }
         #sidebar .form-control[readonly] {
             background-color: #e9ecef; /* Standard disabled background */
             cursor: not-allowed;
             opacity: 0.7;
         }
        #sidebar .input-group-text {
             font-size: 0.9rem;
             background-color: var(--border-color); /* Match border */
             border: 1px solid var(--border-color);
             color: var(--text-muted);
        }
        #sidebar .btn {
            font-size: 0.9rem;
            width: 100%;
            margin-top: 0.5rem;
            font-weight: 500;
            padding: 0.5rem;
        }
        .btn-manage-expenses {
            background-color: var(--accent-purple);
            border-color: var(--accent-purple);
            color: #fff;
        }
        .btn-manage-expenses:hover {
            background-color: var(--primary-purple);
            border-color: var(--primary-purple);
            color: #fff;
        }
         .btn-manage-products {
            background-color: var(--accent-teal);
            border-color: var(--accent-teal);
            color: #fff;
        }
        .btn-manage-products:hover {
             background-color: #1e8e83; /* Darker teal */
             border-color: #1e8e83;
             color: #fff;
         }
        .required-label .text-danger {
            margin-left: 2px;
        }


        /* --- Main Content --- */
        #main-content {
            padding: 2rem;
            background-color: var(--content-bg);
            transition: background-color 0.3s ease;
            min-height: calc(100vh - var(--navbar-height));
        }
        .section-title {
            margin-bottom: 1.5rem;
            font-weight: 600;
            color: var(--text-color);
            font-size: 1.2rem;
             display: flex;
             align-items: center;
        }
         .section-title i {
             margin-right: 0.75rem;
             color: var(--primary-purple);
         }
        .card {
            border: 1px solid var(--border-color);
            background-color: var(--card-bg);
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
         .card-header {
            background-color: #f8f9fa; /* Light gray header */
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
             padding: 0.75rem 1.25rem;
             font-size: 0.95rem;
             transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .card-body {
            padding: 1.25rem;
        }
        .card-title-sm { /* For result cards */
            font-size: 0.85rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 0.3rem;
            font-weight: 500;
        }
        .card-value {
            /* font-size: 1.6rem; -- Original */
            font-size: 1.4rem; /* Reduced font size */
            font-weight: 600;
            color: var(--text-color);
        }
        .card-value.positive { color: var(--positive-color); }
        .card-value.negative { color: var(--negative-color); }
        .bg-light-yellow { background-color: var(--light-yellow-bg) !important; }

        /* Simulation Results Card Hover */
        .simulation-results .card {
             transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        .simulation-results .card:hover {
             transform: translateY(-3px);
             box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
         body.dark-mode .simulation-results .card:hover {
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
         }

        /* Funnel Flow Visualization */
        .funnel-flow-viz {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 1rem; /* Reduced from 2rem */
            overflow: hidden; /* Contain elements during animation */
            max-width: 85%; /* Constrain width */
            margin-left: auto;
            margin-right: auto;
        }
        .funnel-box, .funnel-arrow-down {
            opacity: 0; /* Initially hidden for animation */
            transform: translateY(-20px); /* Start slightly up */
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }
        .funnel-flow-viz.funnel-visible .funnel-box,
        .funnel-flow-viz.funnel-visible .funnel-arrow-down {
            opacity: 1;
            transform: translateY(0);
        }
        .funnel-box {
            /* background-color: var(--accent-purple); Removed for gradient */
            color: #fff;
            padding: 0.6rem 1.2rem; /* Reduced padding */
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
            position: relative;
            margin-bottom: 0.5rem; /* Reduced margin */
            clip-path: polygon(5% 0%, 95% 0%, 100% 100%, 0% 100%);
            width: 230px; /* Reduced width */
            min-height: 55px; /* Reduced height */
            display: flex;
            flex-direction: column;
            justify-content: center;
            border: 1px solid rgba(255, 255, 255, 0.1); /* Subtle border */
        }
        .funnel-box:nth-child(1) { /* Visitors */
            width: 300px;
            background: linear-gradient(135deg, var(--accent-purple) 0%, #8e44ad 100%); /* Lighter Purple gradient */
            border-radius: 8px 8px 0 0;
        }
        .funnel-box:nth-child(3) { /* Optins */
            width: 250px;
             background: linear-gradient(135deg, #5e35b1 0%, var(--primary-purple) 100%); /* Medium Purple gradient */
        }
        .funnel-box:nth-child(5) { /* Attendees */
            width: 200px;
            background: linear-gradient(135deg, #4527a0 0%, #311b92 100%); /* Darker Purple gradient */
        }
        .funnel-box:nth-child(7) { /* Customers */
            width: 150px;
            background: linear-gradient(135deg, var(--secondary-blue) 0%, #1e88e5 100%); /* Blue gradient */
            border-radius: 0 0 8px 8px;
        }

        /* Animation Delays */
        .funnel-flow-viz.funnel-visible .funnel-box:nth-child(1) { transition-delay: 0.1s; }
        .funnel-flow-viz.funnel-visible .funnel-arrow-down:nth-child(2) { transition-delay: 0.3s; }
        .funnel-flow-viz.funnel-visible .funnel-box:nth-child(3) { transition-delay: 0.5s; }
        .funnel-flow-viz.funnel-visible .funnel-arrow-down:nth-child(4) { transition-delay: 0.7s; }
        .funnel-flow-viz.funnel-visible .funnel-box:nth-child(5) { transition-delay: 0.9s; }
        .funnel-flow-viz.funnel-visible .funnel-arrow-down:nth-child(6) { transition-delay: 1.1s; }
        .funnel-flow-viz.funnel-visible .funnel-box:nth-child(7) { transition-delay: 1.3s; }


        .funnel-box .value {
            display: block;
            font-size: 1.3rem; /* Reduced font size */
            font-weight: bold;
        }
        .funnel-box .label {
            display: block;
            font-size: 0.8rem; /* Reduced font size */
            opacity: 0.9;
        }
        .funnel-arrow-down {
            font-size: 1rem; /* Reduced size */
            color: var(--text-muted);
            margin-bottom: 0.5rem; /* Reduced margin */
            /* transition properties inherited or set explicitly */
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }


        /* Product Performance Table */
        .product-performance-table {
            width: 100%;
            font-size: 0.85rem; /* Slightly smaller */
            border-collapse: collapse; /* Remove gaps */
        }
        .product-performance-table th,
        .product-performance-table td {
            border: 1px solid var(--border-color);
            padding: 0.5rem 0.75rem;
            text-align: left;
            vertical-align: middle;
        }
        .product-performance-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            white-space: nowrap; /* Prevent header wrapping */
        }
        .product-performance-table tbody tr {
            transition: background-color 0.2s ease;
        }
        .product-performance-table tbody tr:hover {
            background-color: rgba(106, 17, 203, 0.05); /* Light purple hover */
        }
        .product-performance-table .text-end {
            text-align: right;
        }
        .product-performance-table .revenue-value.positive { color: var(--positive-color); }
        .product-performance-table .revenue-value.negative { color: var(--negative-color); }
        body.dark-mode .product-performance-table th {
            background-color: #333;
        }
        body.dark-mode .product-performance-table th,
        body.dark-mode .product-performance-table td {
            border-color: var(--dark-border-color);
        }
        body.dark-mode .product-performance-table tbody tr:hover {
            background-color: rgba(126, 87, 194, 0.15);
        }
        body.dark-mode .product-performance-table .revenue-value.positive { color: var(--dark-positive-color); }
        body.dark-mode .product-performance-table .revenue-value.negative { color: var(--dark-negative-color); }


        /* Charts */
        .chart-container {
            position: relative;
            height: 300px; /* Increased height */
            width: 100%;
            min-width: 100%; /* Ensure full width */
        }

        /* Sensitivity Analysis */
        .sensitivity-current-values {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 1.5rem;
        }
        .current-value-item {
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.5rem 1rem;
            text-align: center;
            transition: all 0.2s ease;
            flex-grow: 1;
            min-width: 100px;
        }
        /* Highlighting for Active SA Metric */
        .current-value-item.sa-active-metric {
            border-color: var(--primary-purple);
            background-color: var(--card-bg);
            box-shadow: 0 0 0 2px rgba(106, 17, 203, 0.2);
            transform: scale(1.03);
        }
        .current-value-item .label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.1rem;
        }
        .current-value-item .value {
            display: block;
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary-purple);
        }
        .sa-controls {
            display: flex;
            align-items: flex-end;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
         .sa-controls .form-label { font-size: 0.85rem; margin-bottom: 0.2rem;}
         .sa-controls .btn { height: calc(1.5em + 0.75rem + 2px); }

        .sa-table { font-size: 0.9rem; }
        .sa-table th { font-weight: 600; background-color: #f8f9fa; }
        .sa-table td, .sa-table th { padding: 0.6rem 0.75rem; vertical-align: middle; }
        .sa-diff.positive { color: var(--positive-color); }
        .sa-diff.negative { color: var(--negative-color); }
        .sa-diff span { font-size: 0.8em; margin-left: 5px; }

        /* Dream Profit Goal */
        .dream-profit-header {
            background-color: var(--dream-profit-header);
            color: #fff;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
         .dream-profit-header .goal-amount {
            font-size: 1.8rem;
            font-weight: bold;
         }
         .dream-profit-table { font-size: 0.9rem; }
         .dream-profit-table th { font-weight: 600; background-color: #f8f9fa; }
         .dream-profit-table td, .dream-profit-table th { padding: 0.6rem 0.75rem; vertical-align: middle; text-align: right; }
         .dream-profit-table th:first-child,
         .dream-profit-table td:first-child { text-align: left; font-weight: 500; }
         .dream-profit-table .btn-download { float: right; margin-top: 1rem; }

        /* Modals */
        .modal-header {
            background-color: var(--primary-purple);
            color: #fff;
        }
         .modal-header .btn-close {
             filter: brightness(0) invert(1);
         }
        .modal-title { font-size: 1.1rem; font-weight: 500; }
        .current-items-list .list-group-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background-color: #f8f9fa;
        }
         .current-items-list .list-group-item.readonly-item {
            background-color: #e9ecef; /* Indicate non-editable */
            opacity: 0.8;
        }
         .current-items-list .list-group-item.readonly-item .item-actions {
            visibility: hidden; /* Hide actions for readonly */
        }
        .current-items-list .item-details span { display: block; font-size: 0.8rem; color: var(--text-muted); }
        .current-items-list .item-actions .btn { padding: 0.1rem 0.4rem; font-size: 0.8rem; }
        .modal-body h6 {
             font-weight: 600;
             margin-top: 1.5rem;
             margin-bottom: 0.75rem;
             font-size: 1rem;
             border-bottom: 1px solid var(--border-color);
             padding-bottom: 0.3rem;
        }
        .modal-body h6:first-child { margin-top: 0; } /* Remove top margin for first header */

        /* Scroll-to-Top Button */
        #scrollTopBtn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 45px;
            height: 45px;
            background-color: var(--accent-purple);
            color: white;
            border: none;
            border-radius: 50%;
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        #scrollTopBtn:hover {
             background-color: var(--primary-purple);
        }

        /* --- Dark Mode --- */
        body.dark-mode {
            background-color: var(--dark-bg);
            color: var(--dark-text-color);
        }
        body.dark-mode .navbar {
             background: linear-gradient(90deg, #3c1053 0%, #5f3ca5 100%);
             box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        body.dark-mode #sidebar {
            background-color: var(--dark-sidebar-bg);
            border-right: 1px solid var(--dark-border-color);
        }
        body.dark-mode #sidebar h5 {
            color: var(--accent-purple);
            border-bottom-color: var(--dark-border-color);
        }
        body.dark-mode #sidebar .form-label { color: var(--dark-text-muted); }
        body.dark-mode #sidebar .form-control,
        body.dark-mode #sidebar .form-select {
            background-color: var(--dark-input-bg);
            color: var(--dark-text-color);
            border-color: var(--dark-border-color);
        }
         body.dark-mode #sidebar .form-control::placeholder { color: var(--dark-text-muted); opacity: 0.7;}
         body.dark-mode #sidebar .form-control:focus,
         body.dark-mode #sidebar .form-select:focus {
             background-color: var(--dark-card-bg);
             border-color: var(--accent-purple);
             box-shadow: 0 0 0 0.2rem rgba(126, 87, 194, 0.3);
             color: var(--dark-text-color);
         }
         body.dark-mode #sidebar .form-control[readonly] {
            background-color: #3a3a3a;
            opacity: 0.6;
         }
        body.dark-mode #sidebar .input-group-text {
             background-color: var(--dark-border-color);
             border-color: var(--dark-border-color);
             color: var(--dark-text-muted);
         }
        body.dark-mode .btn-manage-expenses { background-color: var(--accent-purple); border-color: var(--accent-purple); color:#fff;}
        body.dark-mode .btn-manage-expenses:hover { background-color: var(--primary-purple); border-color: var(--primary-purple);}
        body.dark-mode .btn-manage-products { background-color: var(--accent-teal); border-color: var(--accent-teal); color:#fff;}
        body.dark-mode .btn-manage-products:hover { background-color: #1e8e83; border-color: #1e8e83;}

        body.dark-mode #main-content { background-color: var(--dark-content-bg); }
        body.dark-mode .section-title { color: var(--dark-text-color); }
        body.dark-mode .section-title i { color: var(--accent-purple); }
        body.dark-mode .card {
            background-color: var(--dark-card-bg);
            border: 1px solid var(--dark-border-color);
            box-shadow: 0 1px 3px rgba(0,0,0,0.15);
        }
        body.dark-mode .card-header {
            background-color: #333;
            border-bottom: 1px solid var(--dark-border-color);
            color: var(--dark-text-color);
        }
        body.dark-mode .card-title-sm { color: var(--dark-text-muted); }
        body.dark-mode .card-value { color: var(--dark-text-color); }
        body.dark-mode .card-value.positive { color: var(--dark-positive-color); }
        body.dark-mode .card-value.negative { color: var(--dark-negative-color); }
        body.dark-mode .bg-light-yellow { background-color: var(--dark-light-yellow-bg) !important; }

        body.dark-mode .funnel-box {
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            border: 1px solid rgba(0, 0, 0, 0.2);
        }
        /* Dark mode funnel gradients could be adjusted if needed, but keeping them vibrant */
        body.dark-mode .funnel-arrow-down { color: var(--dark-text-muted); }
        /* body.dark-mode .product-perf-display { color: var(--dark-text-muted); } -- Removed */
        /* body.dark-mode .product-perf-display span { color: var(--dark-text-color); } -- Removed */

        body.dark-mode .sensitivity-current-values .current-value-item {
            background-color: var(--dark-input-bg);
            border: 1px solid var(--dark-border-color);
        }
         body.dark-mode .current-value-item.sa-active-metric {
            border-color: var(--accent-purple);
            background-color: var(--dark-card-bg);
            box-shadow: 0 0 0 2px rgba(126, 87, 194, 0.25);
         }
        body.dark-mode .sensitivity-current-values .current-value-item .label { color: var(--dark-text-muted);}
        body.dark-mode .sensitivity-current-values .current-value-item .value { color: var(--accent-purple);}
        body.dark-mode .sa-table th, body.dark-mode .dream-profit-table th { background-color: #333; }
        body.dark-mode .sa-table td, body.dark-mode .sa-table th,
        body.dark-mode .dream-profit-table td, body.dark-mode .dream-profit-table th { border-color: var(--dark-border-color); }
        /* Force black text for the first column in SA table for better readability */
        body.dark-mode .sa-table td:first-child { color: #212529; font-weight: 600; }
        /* Set colors for positive/negative values */
        body.dark-mode .sa-diff.positive { color: var(--dark-positive-color); }
        body.dark-mode .sa-diff.negative { color: var(--dark-negative-color); }

        body.dark-mode .dream-profit-header { background-color: var(--dark-dream-profit-header); }
        /* Regular text color for first column in dark mode */
        body.dark-mode .dream-profit-table td:first-child { color: var(--dark-text-color);}
        /* Ensure white text on dark headers in dark mode */
        body.dark-mode .dream-profit-table th { color: var(--dark-text-color); }
        /* Force black text for METRIC column in dark mode for better readability */
        body.dark-mode .dream-profit-table td:first-child { color: #212529; font-weight: 600; }

        body.dark-mode .modal-content { background-color: var(--dark-card-bg); }
        body.dark-mode .modal-header { background-color: var(--accent-purple); border-bottom-color: var(--dark-border-color); }
        body.dark-mode .modal-body, body.dark-mode .modal-footer { border-color: var(--dark-border-color); }
        body.dark-mode .modal-body h6 { border-bottom-color: var(--dark-border-color); color: var(--dark-text-color); }
        body.dark-mode .current-items-list .list-group-item {
             border-color: var(--dark-border-color);
             background-color: var(--dark-sidebar-bg);
        }
         body.dark-mode .current-items-list .list-group-item.readonly-item {
            background-color: #3a3a3a;
        }
        body.dark-mode .current-items-list .item-details span { color: var(--dark-text-muted); }

        body.dark-mode #scrollTopBtn { background-color: var(--accent-purple); }
        body.dark-mode #scrollTopBtn:hover { background-color: var(--primary-purple); }

        /* Responsiveness */
        @media (max-width: 992px) {
             :root { --sidebar-width: 0; }
             body { padding-left: 0; }
             #sidebar { transform: translateX(-110%); display: none; }
             #main-content { margin-left: 0; }
             .navbar .btn, .navbar-text, .navbar .form-check { display: none; }
        }
         @media (max-width: 768px) {
            .funnel-flow-viz { flex-direction: column; }
            .funnel-box { width: 90%; max-width: 250px; }
            .simulation-results .col-md-6 { flex: 0 0 50%; max-width: 50%;}
            .sa-controls { flex-direction: column; align-items: stretch; }
            .sensitivity-current-values { justify-content: center;}
            .current-value-item { flex-basis: 45%; }
            .dream-profit-table { font-size: 0.8rem;}
            .dream-profit-table td, .dream-profit-table th { padding: 0.4rem; }
            .dream-profit-header .goal-amount { font-size: 1.5rem;}
            /* Adjust left col layout on smaller screens if needed */
            #main-content .col-lg-7 .row .col-md-6 { flex: 0 0 100%; max-width: 100%; } /* Stack charts */
            .product-performance-table { font-size: 0.8rem; } /* Smaller font on mobile */
            .product-performance-table th, .product-performance-table td { padding: 0.4rem; }
         }

    </style>
</head>
<body>

    <!-- Top Navigation Bar -->
    <nav class="navbar navbar-expand fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-chart-pie me-2"></i>Webinar Hackers Simulator
            </a>

            <div class="d-flex align-items-center ms-auto">
                 <!-- Action Buttons -->
                 <button class="btn btn-light btn-sm" id="simulateBtn"><i class="fas fa-play me-1"></i> Simulate</button>
                 <button class="btn btn-light btn-sm" id="pdfBtn"><i class="fas fa-file-pdf me-1"></i> PDF</button>
                 <!-- Excel Button Removed -->
                 <!-- Share Button Removed -->

                 <!-- Dark Mode Toggle -->
                <div class="form-check form-switch mx-3">
                    <input class="form-check-input" type="checkbox" role="switch" id="darkModeToggle">
                    <label class="form-check-label" for="darkModeToggle"><i class="fas fa-moon"></i></label>
                </div>

                <!-- Logged-in User -->
                <span class="navbar-text d-none d-lg-inline">
                    <i class="fas fa-user-circle me-1"></i> Funnel Ai <!-- Username Changed -->
                </span>
            </div>
        </div>
    </nav>

    <!-- Left Sidebar -->
    <div id="sidebar">
        <!-- Advertising Costs -->
        <div class="mb-4">
            <h5><i class="fas fa-bullhorn me-2"></i>Advertising Costs</h5>
            <div class="mb-3">
                <label for="weeklyAdSpend" class="form-label required-label">Weekly Ad Spend ($) <span class="text-danger">*</span></label>
                <input type="number" class="form-control" id="weeklyAdSpend" value="700" step="10" min="0">
            </div>
             <div class="mb-3">
                <label for="adsCPC" class="form-label required-label">ADS CPC ($) <span class="text-danger">*</span></label>
                <input type="number" class="form-control" id="adsCPC" value="1.00" step="0.01" min="0.01">
            </div>
            <div class="mb-3">
                 <label for="weeklyVisitors" class="form-label">Weekly Visitors to Reg Page</label>
                 <input type="number" class="form-control" id="weeklyVisitors" value="700" step="1" readonly>
                  <small class="text-muted d-block mt-1" style="font-size: 0.75rem;">Calculated: Weekly Spend / CPC</small>
             </div>
        </div>

        <!-- Funnel Configuration -->
        <div class="mb-4">
            <h5><i class="fas fa-filter me-2"></i>Funnel Configuration</h5>
            <div class="mb-3">
                <label for="optinRate" class="form-label required-label">Opt-in Rate (%) <span class="text-danger">*</span></label>
                <input type="number" class="form-control" id="optinRate" value="30.0" step="0.1" min="0" max="100">
            </div>
            <div class="mb-3">
                <label for="attendanceRate" class="form-label required-label">Attendance Rate (%) <span class="text-danger">*</span></label>
                 <input type="number" class="form-control" id="attendanceRate" value="40.0" step="0.1" min="0" max="100">
            </div>
             <div class="mb-3">
                <label for="conversionCore" class="form-label required-label">Webinar Conv Rate (Core Offer) (%) <span class="text-danger">*</span></label>
                 <input type="number" class="form-control" id="conversionCore" value="15.0" step="0.1" min="0" max="100">
            </div>
             <div class="mb-3">
                <label for="conversionBump" class="form-label required-label">Order Bump Conv Rate (%) <span class="text-danger">*</span></label>
                 <input type="number" class="form-control" id="conversionBump" value="30.0" step="0.1" min="0" max="100">
            </div>
             <div class="mb-3">
                <label for="conversionUpsell" class="form-label required-label">Upsell 1 Conv Rate (%) <span class="text-danger">*</span></label>
                 <input type="number" class="form-control" id="conversionUpsell" value="20.0" step="0.1" min="0" max="100">
            </div>
             <div class="mb-3">
                <label for="conversionDownsell" class="form-label required-label">Downsell 1 Conv Rate (%) <span class="text-danger">*</span></label>
                 <input type="number" class="form-control" id="conversionDownsell" value="25.0" step="0.1" min="0" max="100">
            </div>
             <div class="mb-3">
                <label for="conversionOTO" class="form-label required-label">Webinar OTO Conv Rate (%) <span class="text-danger">*</span></label>
                 <input type="number" class="form-control" id="conversionOTO" value="15.0" step="0.1" min="0" max="100">
            </div>
        </div>

         <!-- Expenses -->
        <div class="mb-4">
            <h5><i class="fas fa-file-invoice-dollar me-2"></i>Expenses</h5>
            <button type="button" class="btn btn-manage-expenses" data-bs-toggle="modal" data-bs-target="#expenseModal">
                <i class="fas fa-edit me-1"></i> Manage Expenses
            </button>
        </div>

        <!-- Products -->
        <div>
            <h5><i class="fas fa-box-open me-2"></i>Products</h5>
            <button type="button" class="btn btn-manage-products" data-bs-toggle="modal" data-bs-target="#productModal">
                 <i class="fas fa-edit me-1"></i> Manage Products
                                <!-- Use data-metric attribute for easier JS targeting -->
            </button>
        </div>
    </div>

    <!-- Main Content Area -->
    <div id="main-content">
        <div class="container-fluid p-0">

            <!-- RESTRUCTURED LAYOUT -->
            
            <!-- First Row: Simulation Results + Funnel Flow side by side -->
            <div class="row mb-4">
                <!-- Simulation Results Section -->
                <div class="col-md-6">
                     <h5 class="section-title"><i class="fas fa-calculator"></i>Simulation Results</h5>
                     <div class="row simulation-results">
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <div class="card-title-sm">Weekly Revenue</div>
                                    <div class="card-value positive" id="resultRevenue">$0.00</div>
                                </div>
                            </div>
                        </div>
                         <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                 <div class="card-body">
                                    <div class="card-title-sm">Weekly Expenses</div>
                                    <div class="card-value" id="resultExpenses">$0.00</div>
                                 </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card h-100 bg-light-yellow">
                                 <div class="card-body">
                                    <div class="card-title-sm">Weekly Net Profit</div>
                                    <div class="card-value positive" id="resultProfit">$0.00</div>
                                </div>
                            </div>
                        </div>
                         <div class="col-md-6 mb-3">
                            <div class="card h-100 bg-light-yellow">
                                 <div class="card-body">
                                    <div class="card-title-sm">ROI</div>
                                    <div class="card-value positive" id="resultROI">0.00%</div>
                                 </div>
                            </div>
                         </div>
                     </div>
                </div>
                
                <!-- Funnel Flow Visualization Section -->
                <div class="col-md-6">
                    <div class="text-center">
                         <h5 class="section-title justify-content-center"><i class="fas fa-filter"></i>Funnel Flow Visualization</h5>
                         <div class="funnel-flow-viz" id="funnelVizContainer">
                             <div class="funnel-box">
                                 <span class="value" id="flowVisitors">0</span>
                                 <span class="label">Weekly Visitors</span>
                             </div>
                             <div class="funnel-arrow-down"><i class="fas fa-arrow-down"></i></div>
                             <div class="funnel-box">
                                 <span class="value" id="flowOptins">0</span>
                                 <span class="label">Opt-ins</span>
                             </div>
                              <div class="funnel-arrow-down"><i class="fas fa-arrow-down"></i></div>
                             <div class="funnel-box">
                                 <span class="value" id="flowAttendees">0</span>
                                 <span class="label">Attendees</span>
                             </div>
                              <div class="funnel-arrow-down"><i class="fas fa-arrow-down"></i></div>
                             <div class="funnel-box">
                                 <span class="value" id="flowCustomers">0</span>
                                 <span class="label">Customers (Core)</span>
                             </div>
                         </div>
                    </div>
                </div>
            </div>

            <!-- Second Row: Charts Row with Funnel Stages + Revenue Breakdown -->
            <div class="row mb-4">
                 <div class="col-md-6 d-flex">
                    <div class="w-100 d-flex flex-column">
                        <h5 class="section-title"><i class="fas fa-chart-bar"></i>Funnel Stages</h5>
                        <div class="card flex-grow-1">
                            <div class="card-body d-flex flex-column">
                                <div class="chart-container flex-grow-1">
                                     <canvas id="funnelStagesChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="col-md-6 d-flex">
                    <div class="w-100 d-flex flex-column">
                        <h5 class="section-title"><i class="fas fa-chart-pie"></i>Revenue Distribution by Product (%)</h5>
                        <div class="card flex-grow-1">
                            <div class="card-body d-flex flex-column">
                                 <div class="chart-container flex-grow-1">
                                    <canvas id="revenueBreakdownChart"></canvas>
                                 </div>
                            </div>
                        </div>
                    </div>
                 </div>
            </div>

            <!-- Third Row: Product Performance Table -->
            <div class="row mb-4">
                <div class="col-12">
                     <h5 class="section-title"><i class="fas fa-tags"></i>Products Performance</h5>
                     <div class="card w-100">
                          <div class="card-body">
                              <div class="table-responsive w-100" id="productPerformanceTableContainer">
                                  <p class="text-muted text-center">Click 'Simulate' to view product performance.</p>
                              </div>
                          </div>
                      </div>
                </div>
            </div>

            <!-- Sensitivity Analysis -->
            <div class="row mb-4">
                <div class="col-12">
                    <h5 class="section-title"><i class="fas fa-search-dollar"></i>Sensitivity Analysis "What If?"</h5>
                    <div class="card">
                        <div class="card-body">
                            <p class="text-muted mb-3">Current Values (Based on last simulation):</p>
                            <div class="sensitivity-current-values">                                <div class="current-value-item" data-metric="weeklyAdSpend">
                                    <span class="label">Weekly Spend</span>
                                    <span class="value" id="saCurrentSpend">$700.00</span> <!-- Initial Value -->
                                </div>
                                <div class="current-value-item" data-metric="cpc">
                                    <span class="label">ADS CPC</span>
                                    <span class="value" id="saCurrentCPC">$1.00</span> <!-- Initial Value -->
                                </div>
                                <div class="current-value-item" data-metric="weeklyVisitors"> <!-- Now directly selectable -->
                                    <span class="label">Weekly Visitors</span>
                                    <span class="value" id="saCurrentVisitors">700</span> <!-- Initial Value -->
                                </div>
                                <div class="current-value-item" data-metric="optin">
                                    <span class="label">Opt-in Rate</span>
                                    <span class="value" id="saCurrentOptin">30.0%</span> <!-- Initial Value -->
                                </div>
                                <div class="current-value-item" data-metric="attendance">
                                    <span class="label">Attendance</span>
                                    <span class="value" id="saCurrentAttendance">40.0%</span> <!-- Initial Value -->
                                </div>
                                <div class="current-value-item" data-metric="conversionCore">
                                    <span class="label">Webinar Conv</span>
                                    <span class="value" id="saCurrentConv">15.0%</span> <!-- Initial Value -->
                                </div>
                                <div class="current-value-item" data-metric="conversionBump">
                                     <span class="label">Order Bump</span>
                                     <span class="value" id="saCurrentBump">30.0%</span> <!-- Initial Value -->
                                 </div>
                                 <div class="current-value-item" data-metric="conversionUpsell">
                                     <span class="label">Upsell 1</span>
                                     <span class="value" id="saCurrentUpsell">20.0%</span> <!-- Initial Value -->
                                 </div>
                                 <div class="current-value-item" data-metric="conversionDownsell">
                                     <span class="label">Downsell 1</span>
                                     <span class="value" id="saCurrentDownsell">25.0%</span> <!-- Initial Value -->
                                 </div>
                                 <div class="current-value-item" data-metric="conversionOTO">
                                     <span class="label">OTO Conv</span>
                                     <span class="value" id="saCurrentOTO">15.0%</span> <!-- Initial Value -->
                                 </div>
                            </div>

                            <div class="sa-controls">
                                <div style="flex-grow: 1;">
                                    <label for="saMetricToVary" class="form-label">Metric to Vary:</label>
                                    <select id="saMetricToVary" class="form-select">
                                        <option value="weeklyAdSpend" selected>Weekly Ad Spend ($)</option>
                                        <option value="cpc">ADS CPC ($)</option>
                                        <option value="weeklyVisitors">Weekly Visitors</option>
                                        <option value="optin">Opt-in Rate (%)</option>
                                        <option value="attendance">Attendance Rate (%)</option>
                                        <option value="conversionCore">Webinar Conv Rate (%)</option>
                                        <option value="conversionBump">Order Bump Conv Rate (%)</option>
                                        <option value="conversionUpsell">Upsell 1 Conv Rate (%)</option>
                                        <option value="conversionDownsell">Downsell 1 Conv Rate (%)</option>
                                        <option value="conversionOTO">Webinar OTO Conv Rate (%)</option>
                                    </select>
                                </div>
                                <div style="width: 150px;">
                                    <label for="saVariation" class="form-label">New Value:</label>
                                    <input type="number" id="saVariation" class="form-control" value="10" step="1">
                                </div>
                                <div>
                                     <label class="form-label">&nbsp;</label> <!-- Spacer -->
                                     <button class="btn btn-primary w-100" id="analyzeSensitivityBtn"><i class="fas fa-sync-alt me-1"></i> Analyze</button>
                                </div>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-bordered table-hover sa-table">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Metric</th>
                                            <th class="text-end">Original</th>
                                            <th class="text-end">After Change</th>
                                            <th class="text-end">Difference</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Weekly Visitors</td>
                                            <td class="text-end" id="saOrigVisitors">0</td>
                                            <td class="text-end" id="saAfterVisitors">0</td>
                                            <td class="text-end sa-diff" id="saDiffVisitors">0 <span>(0.00%)</span></td>
                                        </tr>
                                        <tr>
                                            <td>Weekly Revenue</td>
                                            <td class="text-end" id="saOrigRevenue">$0.00</td>
                                            <td class="text-end" id="saAfterRevenue">$0.00</td>
                                            <td class="text-end sa-diff" id="saDiffRevenue">$0.00 <span>(0.00%)</span></td>
                                        </tr>
                                        <tr>
                                            <td>Weekly Expenses</td>
                                            <td class="text-end" id="saOrigExpenses">$0.00</td>
                                            <td class="text-end" id="saAfterExpenses">$0.00</td>
                                            <td class="text-end sa-diff" id="saDiffExpenses">$0.00 <span>(0.00%)</span></td>
                                        </tr>
                                        <tr>
                                            <td>Product Costs</td>
                                             <td class="text-end" id="saOrigProdCosts">$0.00</td>
                                            <td class="text-end" id="saAfterProdCosts">$0.00</td>
                                            <td class="text-end sa-diff" id="saDiffProdCosts">$0.00 <span>(0.00%)</span></td>
                                        </tr>
                                        <tr>
                                            <td>Weekly Profit</td>
                                            <td class="text-end" id="saOrigProfit">$0.00</td>
                                            <td class="text-end" id="saAfterProfit">$0.00</td>
                                            <td class="text-end sa-diff" id="saDiffProfit">$0.00 <span>(0.00%)</span></td>
                                        </tr>
                                        <tr>
                                            <td>ROI (%)</td>
                                            <td class="text-end" id="saOrigROI">0.00%</td>
                                            <td class="text-end" id="saAfterROI">0.00%</td>
                                            <td class="text-end sa-diff" id="saDiffROI">0.00% <span>(0.00%)</span></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                             <!-- Sensitivity Comparison Chart -->
                             <div class="mt-4">
                                 <h6 class="text-center text-muted">Sensitivity Analysis Comparison</h6>
                                <div class="chart-container" style="height: 250px;">
                                    <canvas id="sensitivityComparisonChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dream Profit Goal -->
            <div class="row mb-4">
                <div class="col-12">
                    <h5 class="section-title"><i class="fas fa-star"></i>Dream Profit Goal</h5>
                     <div class="card">
                        <div class="card-body">
                           <div class="row align-items-end mb-4">
                               <div class="col-md-5">
                                    <label for="dreamProfitGoalInput" class="form-label">Enter Your Dream ANNUAL Profit Goal ($):</label>
                                     <input type="number" class="form-control" id="dreamProfitGoalInput" value="100000" step="5000" min="0">
                               </div>
                               <div class="col-md-3">
                                    <button class="btn btn-primary w-100" id="calculateDreamProfitBtn"><i class="fas fa-calculator me-1"></i> Calculate</button>
                               </div>
                           </div>

                            <div class="dream-profit-header">
                                <span>Dream Annual Profit Goal</span>
                                <span class="goal-amount" id="dpgHeaderAmount">$100,000</span>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-bordered table-hover dream-profit-table">
                                      <thead class="table-light">
                                          <tr>
                                              <th>METRIC (Required)</th>
                                              <th>DAY</th>
                                              <th>WEEK</th>
                                              <th>MONTH</th>
                                              <th>YEAR</th>
                                          </tr>
                                      </thead>
                                      <tbody>
                                           <tr>
                                               <td>REVENUE</td>
                                               <td id="dpgDayRevenue">$0.00</td>
                                               <td id="dpgWeekRevenue">$0.00</td>
                                               <td id="dpgMonthRevenue">$0.00</td>
                                               <td id="dpgYearRevenue">$0.00</td>
                                           </tr>
                                           <tr>
                                               <td>PROFIT</td>
                                               <td id="dpgDayProfit">$0.00</td>
                                               <td id="dpgWeekProfit">$0.00</td>
                                               <td id="dpgMonthProfit">$0.00</td>
                                               <td id="dpgYearProfit">$0.00</td>
                                           </tr>
                                            <tr>
                                                <td>VISITORS</td>
                                                <td id="dpgDayTraffic">0</td>
                                                <td id="dpgWeekTraffic">0</td>
                                                <td id="dpgMonthTraffic">0</td>
                                                <td id="dpgYearTraffic">0</td>
                                            </tr>
                                            <tr>
                                               <td>TRAFFIC COST (ADS)</td>
                                                <td id="dpgDayCost">$0.00</td>
                                                <td id="dpgWeekCost">$0.00</td>
                                                <td id="dpgMonthCost">$0.00</td>
                                                <td id="dpgYearCost">$0.00</td>
                                           </tr>
                                            <tr>
                                                <td>LEADS (REGISTRATIONS)</td>
                                                <td id="dpgDayLeads">0</td>
                                                <td id="dpgWeekLeads">0</td>
                                                <td id="dpgMonthLeads">0</td>
                                                <td id="dpgYearLeads">0</td>
                                           </tr>
                                      </tbody>
                                  </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div> <!-- /.container-fluid -->
    </div> <!-- /#main-content -->

    <!-- Expense Modal -->
    <div class="modal fade" id="expenseModal" tabindex="-1" aria-labelledby="expenseModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="expenseModalLabel"><i class="fas fa-file-invoice-dollar me-2"></i>Manage Expenses</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h6>Current Expenses</h6>
                    <div class="current-items-list mb-4" id="currentExpensesList">
                        <!-- Expenses added dynamically by JS -->
                        <p class="text-muted text-center mt-2" id="noOtherExpensesText" style="display: none;">No other expenses added yet.</p>
                    </div>

                    <h6>Add New Expense</h6>
                    <form id="addExpenseForm">
                        <input type="hidden" id="editExpenseId"> <!-- For editing -->
                        <div class="mb-3">
                            <label for="expenseName" class="form-label">Expense Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="expenseName" placeholder="e.g. Software, Hosting, VA" required>
                        </div>
                        <div class="mb-3">
                            <label for="expenseAmount" class="form-label">Amount ($) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="expenseAmount" step="0.01" placeholder="0.00" required min="0">
                        </div>
                        <div class="mb-3">
                            <label for="expenseFrequency" class="form-label">Frequency <span class="text-danger">*</span></label>
                            <select class="form-select" id="expenseFrequency" required>
                                <option value="Weekly" selected>Weekly</option>
                                <option value="Monthly">Monthly</option>
                                <option value="Annually">Annually</option>
                            </select>
                        </div>
                         <button type="submit" class="btn btn-primary w-100" id="addExpenseBtn">Add Expense</button>
                         <button type="button" class="btn btn-secondary w-100 mt-2" id="cancelEditExpenseBtn" style="display:none;">Cancel Edit</button>
                    </form>
                </div>
                 <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

     <!-- Product Modal -->
    <div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalLabel"><i class="fas fa-box-open me-2"></i>Manage Products</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                     <h6>Current Products</h6>
                    <div class="current-items-list mb-4" id="currentProductsList">
                         <!-- Products added dynamically by JS -->
                         <p class="text-muted text-center mt-2" id="noProductsText" style="display: none;">No products added yet. Add at least a 'Main Offer'.</p>
                    </div>

                     <h6>Add / Edit Product</h6>
                     <form id="addProductForm">
                        <input type="hidden" id="editProductId"> <!-- For editing -->
                        <div class="mb-3">
                            <label for="productName" class="form-label">Product Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="productName" placeholder="e.g. Signature Course" required>
                        </div>
                         <div class="mb-3">
                            <label for="productType" class="form-label">Product Type <span class="text-danger">*</span></label>
                            <select class="form-select" id="productType" required>
                                <option value="" disabled selected>-- Select Type --</option>
                                <option value="Main Offer">Main Offer</option>
                                <option value="Order Bump">Order Bump</option>
                                <option value="Upsell 1">Upsell 1</option>
                                <option value="Downsell 1">Downsell 1</option>
                                <option value="OTO">OTO (One Time Offer)</option>
                            </select>
                             <small class="text-muted d-block mt-1" style="font-size: 0.75rem;">Ensure you have one product for each type used in the funnel.</small>
                        </div>
                        <div class="mb-3">
                            <label for="productPrice" class="form-label">Price ($) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="productPrice" step="0.01" placeholder="0.00" required min="0">
                        </div>
                         <div class="mb-3">
                            <label for="productCost" class="form-label">Cost ($)</label>
                            <input type="number" class="form-control" id="productCost" step="0.01" placeholder="0.00" value="0" min="0">
                         </div>
                          <button type="submit" class="btn btn-primary w-100" id="addProductBtn">Add Product</button>
                          <button type="button" class="btn btn-secondary w-100 mt-2" id="cancelEditProductBtn" style="display:none;">Cancel Edit</button>
                    </form>
                </div>
                 <div class="modal-footer">
                     <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                 </div>
            </div>
        </div>
    </div>

    <!-- Scroll-to-Top Button -->
    <button id="scrollTopBtn" title="Go to top">
        <i class="fas fa-arrow-up"></i>
    </button>


    <!-- Bootstrap 5 JS Bundle (includes Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Embedded JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- Globals & References ---
            const body = document.body;
            const darkModeToggle = document.getElementById('darkModeToggle');
            let funnelStagesChartInstance = null;
            let revenueBreakdownChartInstance = null;
            let sensitivityComparisonChartInstance = null;
            const scrollTopBtn = document.getElementById('scrollTopBtn');
            const funnelVizContainer = document.getElementById('funnelVizContainer');

            // Global Data Stores
            let products = [
                 { id: Date.now() + 1, name: 'Sample Core Product', type: 'Main Offer', price: 497, cost: 0 },
                 { id: Date.now() + 2, name: 'Sample Bump', type: 'Order Bump', price: 47, cost: 0 },
                 { id: Date.now() + 3, name: 'Sample Upsell', type: 'Upsell 1', price: 997, cost: 0 },
                 { id: Date.now() + 4, name: 'Sample Downsell', type: 'Downsell 1', price: 297, cost: 0 },
                 { id: Date.now() + 5, name: 'Sample OTO', type: 'OTO', price: 197, cost: 0 }
            ];
            let expenses = [];
            let lastSimulationResults = null; // Store last results

            // Input References (Sidebar)
            const weeklyAdSpendInput = document.getElementById('weeklyAdSpend');
            const cpcInput = document.getElementById('adsCPC');
            const weeklyVisitorsInput = document.getElementById('weeklyVisitors');
            const optinRateInput = document.getElementById('optinRate');
            const attendanceRateInput = document.getElementById('attendanceRate');
            const conversionCoreInput = document.getElementById('conversionCore');
            const conversionBumpInput = document.getElementById('conversionBump');
            const conversionUpsellInput = document.getElementById('conversionUpsell');
            const conversionDownsellInput = document.getElementById('conversionDownsell');
            const conversionOTOInput = document.getElementById('conversionOTO');

            // Output References (Main Content)
            const flowVisitors = document.getElementById('flowVisitors');
            const flowOptins = document.getElementById('flowOptins');
            const flowAttendees = document.getElementById('flowAttendees');
            const flowCustomers = document.getElementById('flowCustomers');
            const resultRevenue = document.getElementById('resultRevenue');
            const resultExpenses = document.getElementById('resultExpenses');
            const resultProfit = document.getElementById('resultProfit');
            const resultROI = document.getElementById('resultROI');
            // Product Perf Elements (Container for table)
            const productPerformanceTableContainer = document.getElementById('productPerformanceTableContainer');


            // Sensitivity Analysis References
            const saCurrentSpend = document.getElementById('saCurrentSpend');
            const saCurrentCPC = document.getElementById('saCurrentCPC');
            const saCurrentVisitors = document.getElementById('saCurrentVisitors');
            const saCurrentOptin = document.getElementById('saCurrentOptin');
            const saCurrentAttendance = document.getElementById('saCurrentAttendance');
            const saCurrentConv = document.getElementById('saCurrentConv');
            const saCurrentBump = document.getElementById('saCurrentBump');
            const saCurrentUpsell = document.getElementById('saCurrentUpsell');
            const saCurrentDownsell = document.getElementById('saCurrentDownsell');
            const saCurrentOTO = document.getElementById('saCurrentOTO');
            const sensitivityCurrentValueItems = document.querySelectorAll('.sensitivity-current-values .current-value-item'); // NodeList
            // Inputs
            const saMetricSelect = document.getElementById('saMetricToVary');
            const saVariationInput = document.getElementById('saVariation');
            const analyzeSensitivityBtn = document.getElementById('analyzeSensitivityBtn');
            // Table Outputs
            const saOrigVisitors = document.getElementById('saOrigVisitors');
            const saAfterVisitors = document.getElementById('saAfterVisitors');
            const saDiffVisitors = document.getElementById('saDiffVisitors');
            const saOrigRevenue = document.getElementById('saOrigRevenue');
            const saAfterRevenue = document.getElementById('saAfterRevenue');
            const saDiffRevenue = document.getElementById('saDiffRevenue');
            const saOrigExpenses = document.getElementById('saOrigExpenses');
            const saAfterExpenses = document.getElementById('saAfterExpenses');
            const saDiffExpenses = document.getElementById('saDiffExpenses');
            const saOrigProdCosts = document.getElementById('saOrigProdCosts');
            const saAfterProdCosts = document.getElementById('saAfterProdCosts');
            const saDiffProdCosts = document.getElementById('saDiffProdCosts');
            const saOrigProfit = document.getElementById('saOrigProfit');
            const saAfterProfit = document.getElementById('saAfterProfit');
            const saDiffProfit = document.getElementById('saDiffProfit');
            const saOrigROI = document.getElementById('saOrigROI');
            const saAfterROI = document.getElementById('saAfterROI');
            const saDiffROI = document.getElementById('saDiffROI');

            // Dream Profit Goal References
            const dreamProfitInput = document.getElementById('dreamProfitGoalInput');
            const calculateDreamProfitBtn = document.getElementById('calculateDreamProfitBtn');
            const dpgHeaderAmount = document.getElementById('dpgHeaderAmount');
            // Table Outputs
            const dpgDayRevenue = document.getElementById('dpgDayRevenue');
            const dpgWeekRevenue = document.getElementById('dpgWeekRevenue');
            const dpgMonthRevenue = document.getElementById('dpgMonthRevenue');
            const dpgYearRevenue = document.getElementById('dpgYearRevenue');
            const dpgDayProfit = document.getElementById('dpgDayProfit');
            const dpgWeekProfit = document.getElementById('dpgWeekProfit');
            const dpgMonthProfit = document.getElementById('dpgMonthProfit');
            const dpgYearProfit = document.getElementById('dpgYearProfit');
            const dpgDayTraffic = document.getElementById('dpgDayTraffic');
            const dpgWeekTraffic = document.getElementById('dpgWeekTraffic');
            const dpgMonthTraffic = document.getElementById('dpgMonthTraffic');
            const dpgYearTraffic = document.getElementById('dpgYearTraffic');
            const dpgDayCost = document.getElementById('dpgDayCost');
            const dpgWeekCost = document.getElementById('dpgWeekCost');
            const dpgMonthCost = document.getElementById('dpgMonthCost');
            const dpgYearCost = document.getElementById('dpgYearCost');
            const dpgDayLeads = document.getElementById('dpgDayLeads');
            const dpgWeekLeads = document.getElementById('dpgWeekLeads');
            const dpgMonthLeads = document.getElementById('dpgMonthLeads');
            const dpgYearLeads = document.getElementById('dpgYearLeads');


            // --- Helper Functions ---
            const formatCurrency = (num) => num || num === 0 ? `$${(num).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : '$0.00';
            const formatNumber = (num, decimals = 0) => num || num === 0 ? (num).toLocaleString('en-US', { minimumFractionDigits: decimals, maximumFractionDigits: decimals }) : '0';
            const formatPercent = (num) => num || num === 0 ? `${(num).toFixed(2)}%` : '0.00%';

            const applyFinancialStyle = (element, value, isDifferenceCell = false) => {
                 element.classList.remove('positive', 'negative');
                 if (value > 0) element.classList.add('positive');
                 if (value < 0) element.classList.add('negative');

                 if (isDifferenceCell && value > 0) {
                    const currentText = element.textContent;
                    if (currentText && !currentText.startsWith('+')) {
                         element.textContent = `+${currentText}`;
                    }
                 }
            };

            const calculateDifference = (original, after) => {
                const diff = after - original;
                const percentDiff = (original !== 0 && !isNaN(original)) ? (diff / Math.abs(original)) * 100 : (after !== 0 ? Infinity : 0);
                 let percentString = '(NaN%)';
                 if (isFinite(percentDiff)) {
                     percentString = `(${(percentDiff >= 0 ? '+' : '')}${percentDiff.toFixed(2)}%)`;
                 } else if (after !== 0 && original === 0) {
                    percentString = '(+Inf%)';
                 } else if (after === 0 && original !== 0) {
                    percentString = '(-100.00%)';
                 } else if (after === 0 && original === 0){
                     percentString = '(0.00%)';
                 }

                return {
                    absolute: diff,
                    percent: percentDiff,
                    percentString: percentString
                };
            };

             // --- Dark Mode ---
            const applyDarkModePreference = () => {
                const isDarkMode = localStorage.getItem('darkMode') === 'true';
                darkModeToggle.checked = isDarkMode;
                if (isDarkMode) {
                    body.classList.add('dark-mode');
                } else {
                    body.classList.remove('dark-mode');
                }
                // Update charts if they exist
                if(funnelStagesChartInstance || revenueBreakdownChartInstance || sensitivityComparisonChartInstance) {
                    updateChartColors();
                }
            };

            darkModeToggle.addEventListener('change', () => {
                if (darkModeToggle.checked) {
                    body.classList.add('dark-mode');
                    localStorage.setItem('darkMode', 'true');
                } else {
                    body.classList.remove('dark-mode');
                    localStorage.setItem('darkMode', 'false');
                }
                 updateChartColors();
            });


            // --- Chart Colors based on Mode ---
            function getChartColors() {
                 const isDarkMode = body.classList.contains('dark-mode');
                 return {
                     backgroundColor: [ /* Adjusted colors for better visibility */
                        'rgba(156, 102, 223, 0.7)', /* Lighter Purple */
                        'rgba(75, 137, 252, 0.7)',  /* Lighter Blue */
                        'rgba(64, 196, 182, 0.7)',  /* Lighter Teal */
                        'rgba(255, 186, 104, 0.7)', /* Lighter Orange */
                        'rgba(128, 142, 228, 0.7)'  /* Lighter Indigo */
                     ],
                      backgroundColorHover: [
                        'rgba(126, 87, 194, 0.9)',
                        'rgba(37, 117, 252, 0.9)',
                        'rgba(38, 166, 154, 0.9)',
                        'rgba(255, 171, 64, 0.9)',
                        'rgba(92, 107, 192, 0.9)'
                     ],
                     borderColor: isDarkMode ? 'rgba(68, 68, 68, 1)' : 'rgba(255, 255, 255, 1)',
                     gridColor: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.08)',
                     ticksColor: isDarkMode ? '#adb5bd' : '#6c757d',
                     legendColor: isDarkMode ? '#e0e0e0' : '#333',
                     tooltipBg: isDarkMode ? '#2c2c2c' : '#fff',
                     tooltipText: isDarkMode ? '#e0e0e0' : '#333'
                 };
            }

            // --- Chart Initialization & Updates ---
             function initOrUpdateChart(chartInstance, chartId, chartType, data, options) {
                const ctx = document.getElementById(chartId)?.getContext('2d');
                if (!ctx) {
                    console.error(`Canvas element with ID '${chartId}' not found.`);
                    return null;
                }
                // Get current colors INSIDE the function to ensure they reflect current mode
                const colors = getChartColors();

                // Ensure plugins and scales objects exist before assigning properties
                options = options || {};
                options.plugins = options.plugins || {};
                options.plugins.tooltip = options.plugins.tooltip || {};
                options.plugins.legend = options.plugins.legend || { labels: {} };
                options.scales = options.scales || {};
                options.scales.y = options.scales.y || { grid: {}, ticks: {} };
                options.scales.x = options.scales.x || { grid: {}, ticks: {} };

                // Apply theme colors to options dynamically
                options.plugins.tooltip.backgroundColor = colors.tooltipBg;
                options.plugins.tooltip.titleColor = colors.tooltipText;
                options.plugins.tooltip.bodyColor = colors.tooltipText;
                if (options.plugins.legend.labels) {
                    options.plugins.legend.labels.color = colors.legendColor;
                }
                if(options.scales.x) {
                    options.scales.x.grid = options.scales.x.grid || {};
                    options.scales.x.ticks = options.scales.x.ticks || {};
                    options.scales.x.grid.color = colors.gridColor; // Always update
                    options.scales.x.ticks.color = colors.ticksColor; // Always update
                }
                if(options.scales.y) {
                    options.scales.y.grid = options.scales.y.grid || {};
                    options.scales.y.ticks = options.scales.y.ticks || {};
                    options.scales.y.grid.color = colors.gridColor; // Always update
                    options.scales.y.ticks.color = colors.ticksColor; // Always update
                }

                if (chartInstance) {
                    chartInstance.data = data;
                    // Merge options carefully, letting the dynamic color settings override previous ones
                    chartInstance.options = Chart.helpers.merge(chartInstance.options, options);
                    chartInstance.update();
                    return chartInstance;
                } else {
                   try {
                       // Pass the dynamically themed options to the new Chart instance
                       return new Chart(ctx, { type: chartType, data, options });
                   } catch (error) {
                       console.error(`Error initializing chart '${chartId}':`, error);
                       return null;
                   }
                }
            }


             function updateChartColors() {
                 // Recreate/Update charts which will use the latest colors via getChartColors() inside initOrUpdateChart
                 if (lastSimulationResults) {
                     createCharts(lastSimulationResults); // Re-runs simulation display which calls createCharts
                 } else {
                     createCharts(); // Initialize charts with correct colors
                 }
                  // Re-running SA will also update its chart colors
                  if (analyzeSensitivityBtn) {
                     analyzeSensitivityBtn.click();
                 }
             }

             function createCharts(simulationData = null) {
                const colors = getChartColors(); // Get current theme colors
                const hasData = simulationData && simulationData.inputs;

                 // --- Funnel Stages Chart ---
                 const funnelStagesData = {
                     labels: ['Opt-in Rate', 'Attendance Rate', 'Webinar Conv Rate'],
                     datasets: [{
                         label: 'Rate (%)',
                         data: hasData ? [
                             simulationData.inputs.rates.optin || 0,
                             simulationData.inputs.rates.attendance || 0,
                             simulationData.inputs.rates.coreConversion || 0
                         ] : [0, 0, 0],
                         backgroundColor: colors.backgroundColor[0], // Use themed color
                         borderColor: colors.borderColor,
                         borderWidth: 1, borderRadius: 4, barPercentage: 0.6,
                     }]
                 };
                 const funnelStagesOptions = {
                     indexAxis: 'x', responsive: true, maintainAspectRatio: false,
                     plugins: { legend: { display: false } }, // Tooltip/Legend colors handled by initOrUpdate
                     scales: {
                         y: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } }, // Grid/Ticks colors handled by initOrUpdate
                         x: { grid: { display: false } } // Grid/Ticks colors handled by initOrUpdate
                     }
                 };
                funnelStagesChartInstance = initOrUpdateChart(funnelStagesChartInstance, 'funnelStagesChart', 'bar', funnelStagesData, funnelStagesOptions);

                // --- Revenue Breakdown Chart ---
                const revenueBreakdownLabels = hasData ? (simulationData.revenueBreakdown?.map(item => item.name) || []) : [];
                const revenueBreakdownValues = hasData ? (simulationData.revenueBreakdown?.map(item => item.revenue) || []) : [];
                const revenueBreakdownData = {
                    labels: revenueBreakdownLabels.length > 0 ? revenueBreakdownLabels : ['No Revenue Yet'],
                    datasets: [{
                        label: 'Revenue',
                        data: revenueBreakdownValues.length > 0 ? revenueBreakdownValues : [1],
                        backgroundColor: revenueBreakdownValues.length > 0 ? colors.backgroundColor : ['#cccccc'], // Use themed colors
                        hoverBackgroundColor: colors.backgroundColorHover, // Use themed colors
                        borderColor: colors.borderColor, borderWidth: 1
                    }]
                 };
                 const revenueBreakdownOptions = {
                     responsive: true, maintainAspectRatio: false,
                     plugins: {
                         legend: { position: 'bottom', labels: { boxWidth: 12, padding: 15 }}, // Colors handled by initOrUpdate
                         tooltip: { // Colors handled by initOrUpdate
                             callbacks: {
                                 label: function(context) {
                                      if (!context.dataset.data || context.dataset.data.length === 0 || !revenueBreakdownValues || revenueBreakdownValues.length === 0) return '';
                                      // Calculate total of all values in the dataset
                                      const total = context.dataset.data.reduce((acc, val) => acc + (parseFloat(val) || 0), 0);
                                      // Get the current value being shown in the tooltip
                                      const value = parseFloat(context.parsed) || 0;
                                      // Calculate percent of total with better precision
                                      const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                      // Format display
                                      return `${context.label}: ${formatCurrency(value)} (${percentage}%)`;
                                 }
                             }
                         }
                     }
                 };
                revenueBreakdownChartInstance = initOrUpdateChart(revenueBreakdownChartInstance, 'revenueBreakdownChart', 'pie', revenueBreakdownData, revenueBreakdownOptions);

                 // --- Sensitivity Comparison Chart --- (Data updated via analyzeSensitivityBtn click)
                 const saChartCtx = document.getElementById('sensitivityComparisonChart');
                 if (saChartCtx) { // Only proceed if canvas exists
                     const origRev = parseFloat(saOrigRevenue?.textContent.replace(/[^0-9.-]+/g,"")) || 0;
                     const afterRev = parseFloat(saAfterRevenue?.textContent.replace(/[^0-9.-]+/g,"")) || 0;
                     const origProf = parseFloat(saOrigProfit?.textContent.replace(/[^0-9.-]+/g,"")) || 0;
                     const afterProf = parseFloat(saAfterProfit?.textContent.replace(/[^0-9.-]+/g,"")) || 0;
                     const origRoiVal = parseFloat(saOrigROI?.textContent.replace('%','')) || 0;
                     const afterRoiVal = parseFloat(saAfterROI?.textContent.replace('%','')) || 0;

                     const sensitivityComparisonData = {
                        labels: ['Weekly Revenue', 'Weekly Profit', 'ROI (%)'],
                         datasets: [
                             { label: 'Original', data: [origRev, origProf, origRoiVal], backgroundColor: colors.backgroundColor[1], borderRadius: 4, barPercentage: 0.5 },
                             { label: 'After Change', data: [afterRev, afterProf, afterRoiVal], backgroundColor: colors.backgroundColor[2], borderRadius: 4, barPercentage: 0.5 }
                         ]
                     };
                     const sensitivityComparisonOptions = {
                         responsive: true, maintainAspectRatio: false, indexAxis: 'y',
                         plugins: { legend: { position: 'top' }}, // Colors handled by initOrUpdate
                         scales: {
                             x: { beginAtZero: true, ticks: { callback: v => v.toLocaleString() } }, // Colors handled by initOrUpdate
                             y: { grid: { display: false } } // Colors handled by initOrUpdate
                         }
                     };
                     sensitivityComparisonChartInstance = initOrUpdateChart(sensitivityComparisonChartInstance, 'sensitivityComparisonChart', 'bar', sensitivityComparisonData, sensitivityComparisonOptions);
                 } else {
                    console.warn("Sensitivity comparison chart canvas not found during createCharts");
                 }
            };


            // --- Core Simulation Logic ---
             function runSimulation(overrideInputs = null) {
                 const currentInputs = overrideInputs ? JSON.parse(JSON.stringify(overrideInputs)) : { // Deep copy overrides
                    weeklyAdSpend: parseFloat(weeklyAdSpendInput.value) || 0,
                    cpc: parseFloat(cpcInput.value) || 0.01,
                    rates: {
                        optin: (parseFloat(optinRateInput.value) || 0),
                        attendance: (parseFloat(attendanceRateInput.value) || 0),
                        coreConversion: (parseFloat(conversionCoreInput.value) || 0),
                        bump: (parseFloat(conversionBumpInput.value) || 0),
                        upsell: (parseFloat(conversionUpsellInput.value) || 0),
                        downsell: (parseFloat(conversionDownsellInput.value) || 0),
                        oto: (parseFloat(conversionOTOInput.value) || 0),
                    },
                    products: [...products], // Use global products
                    expenses: [...expenses] // Use global expenses
                 };
                 if (currentInputs.cpc <= 0) currentInputs.cpc = 0.01;

                 // Perform Calculations
                 const calculatedVisitors = currentInputs.weeklyAdSpend / currentInputs.cpc;
                 const optins = calculatedVisitors * (currentInputs.rates.optin / 100);
                 const attendees = optins * (currentInputs.rates.attendance / 100);
                 const coreCustomers = attendees * (currentInputs.rates.coreConversion / 100);

                 // Helper to get product details
                 const getProductDetail = (type, detail = 'price') => {
                     const product = currentInputs.products.find(p => p.type === type);
                     return product ? (product[detail] || 0) : 0;
                 };

                 // Calculate customers for each product type
                 const bumpCustomers = coreCustomers * (currentInputs.rates.bump / 100);
                 const upsellCustomers = coreCustomers * (currentInputs.rates.upsell / 100);
                 const downsellCustomers = (coreCustomers - upsellCustomers) * (currentInputs.rates.downsell / 100); // Downsell applies to those who *didn't* take upsell
                 const otoCustomers = coreCustomers * (currentInputs.rates.oto / 100); // Assuming OTO is offered to all core buyers

                 // Calculate revenue per product type
                 const revenueData = [
                     { type: 'Main Offer', name: currentInputs.products.find(p => p.type === 'Main Offer')?.name || 'Main Offer', customers: coreCustomers, revenue: coreCustomers * getProductDetail('Main Offer', 'price') },
                     { type: 'Order Bump', name: currentInputs.products.find(p => p.type === 'Order Bump')?.name || 'Order Bump', customers: bumpCustomers, revenue: bumpCustomers * getProductDetail('Order Bump', 'price') },
                     { type: 'Upsell 1', name: currentInputs.products.find(p => p.type === 'Upsell 1')?.name || 'Upsell 1', customers: upsellCustomers, revenue: upsellCustomers * getProductDetail('Upsell 1', 'price') },
                     { type: 'Downsell 1', name: currentInputs.products.find(p => p.type === 'Downsell 1')?.name || 'Downsell 1', customers: downsellCustomers, revenue: downsellCustomers * getProductDetail('Downsell 1', 'price') },
                     { type: 'OTO', name: currentInputs.products.find(p => p.type === 'OTO')?.name || 'OTO', customers: otoCustomers, revenue: otoCustomers * getProductDetail('OTO', 'price') },
                 ];
                 const totalRevenue = revenueData.reduce((sum, item) => sum + item.revenue, 0);

                 // Calculate Expenses
                 const totalAdSpend = currentInputs.weeklyAdSpend;
                 const totalOtherWeeklyExpenses = currentInputs.expenses.reduce((sum, expense) => {
                     const amount = expense.amount || 0;
                     switch (expense.frequency) {
                         case 'Weekly': return sum + amount;
                         case 'Monthly': return sum + (amount / (365.25 / 7 / 12)); // Avg weeks/month
                         case 'Annually': return sum + (amount / (365.25 / 7)); // Avg weeks/year
                         default: return sum;
                     }
                 }, 0);

                 const totalProductCost = (coreCustomers * getProductDetail('Main Offer', 'cost')) +
                                          (bumpCustomers * getProductDetail('Order Bump', 'cost')) +
                                          (upsellCustomers * getProductDetail('Upsell 1', 'cost')) +
                                          (downsellCustomers * getProductDetail('Downsell 1', 'cost')) +
                                          (otoCustomers * getProductDetail('OTO', 'cost'));

                 const totalExpenses = totalAdSpend + totalOtherWeeklyExpenses + totalProductCost;

                 // Calculate Profit & ROI
                 const netProfit = totalRevenue - totalExpenses;
                 const roi = totalExpenses > 0 ? (netProfit / totalExpenses) * 100 : (totalRevenue > 0 ? Infinity : 0); // Avoid division by zero

                 // Return comprehensive results object
                return {
                    inputs: currentInputs, // The inputs used for this simulation run
                    flow: {
                        visitors: calculatedVisitors,
                        optins: optins,
                        attendees: attendees,
                        customers: coreCustomers // Base customers (core offer)
                    },
                    results: {
                        revenue: totalRevenue,
                        expenses: totalExpenses,
                        profit: netProfit,
                        roi: roi,
                        adSpend: totalAdSpend,
                        otherExpenses: totalOtherWeeklyExpenses,
                        productCosts: totalProductCost
                    },
                    // Revenue breakdown for chart - filter out items with no customers or where revenue is exactly 0 
                    revenueBreakdown: revenueData
                        .filter(item => item.customers > 0 && item.revenue > 0)
                        .map(item => ({ 
                            name: item.name, 
                            revenue: parseFloat(item.revenue.toFixed(2)) // Ensure consistent precision
                        })),
                    // Customer counts per *type* for product performance table
                    customerCounts: revenueData.reduce((acc, item) => {
                        acc[item.type] = item.customers;
                        return acc;
                    }, {})
                };
            }


            // --- Display Simulation Results ---
            function displaySimulationResults(data) {
                if (!data || !data.results || !data.flow || !data.inputs) {
                    console.error("Invalid data passed to displaySimulationResults:", data);
                    return; // Exit if data structure is incomplete
                }
                lastSimulationResults = data; // Store the latest results globally

                // Funnel Flow Update
                flowVisitors.textContent = formatNumber(data.flow.visitors);
                flowOptins.textContent = formatNumber(data.flow.optins);
                flowAttendees.textContent = formatNumber(data.flow.attendees);
                flowCustomers.textContent = formatNumber(data.flow.customers);

                // Trigger Funnel Animation
                if (funnelVizContainer) {
                    funnelVizContainer.classList.remove('funnel-visible');
                    void funnelVizContainer.offsetWidth; // Force reflow
                    funnelVizContainer.classList.add('funnel-visible');
                }


                // Result Cards
                resultRevenue.textContent = formatCurrency(data.results.revenue); applyFinancialStyle(resultRevenue, data.results.revenue);
                resultExpenses.textContent = formatCurrency(data.results.expenses);
                resultProfit.textContent = formatCurrency(data.results.profit); applyFinancialStyle(resultProfit, data.results.profit);
                resultROI.textContent = isFinite(data.results.roi) ? formatPercent(data.results.roi) : 'INF%'; applyFinancialStyle(resultROI, data.results.profit >= 0); // Style ROI based on profit sign

                // Product Performance Table
                 renderProductPerformanceTable(data);

                 // Sensitivity "Current Values" - Update based on the simulation that just ran
                 saCurrentSpend.textContent = formatCurrency(data.inputs.weeklyAdSpend);
                 saCurrentCPC.textContent = formatCurrency(data.inputs.cpc);
                 saCurrentVisitors.textContent = formatNumber(data.flow.visitors);
                 saCurrentOptin.textContent = formatPercent(data.inputs.rates.optin);
                 saCurrentAttendance.textContent = formatPercent(data.inputs.rates.attendance);
                 saCurrentConv.textContent = formatPercent(data.inputs.rates.coreConversion);
                 saCurrentBump.textContent = formatPercent(data.inputs.rates.bump);
                 saCurrentUpsell.textContent = formatPercent(data.inputs.rates.upsell);
                 saCurrentDownsell.textContent = formatPercent(data.inputs.rates.downsell);
                 saCurrentOTO.textContent = formatPercent(data.inputs.rates.oto);

                 // Charts - Update with the new data
                 createCharts(data); // This function handles chart updates

                 // Re-run Dream Profit & Sensitivity based on new results ONLY if the buttons exist
                 if (calculateDreamProfitBtn) calculateDreamProfitBtn.click();
                 if (analyzeSensitivityBtn) analyzeSensitivityBtn.click(); // This will also update the SA chart
            }

            // --- Run Simulation and Update UI (Triggered by Button) ---
            function runSimulationAndDisplay() {
                updateCalculatedVisitors(); // Keep sidebar visitor count updated instantly
                if (!products.some(p => p.type === 'Main Offer')) {
                     alert("Please add a 'Main Offer' product in the Product Modal before simulating.");
                     return;
                }
                try {
                    const simulationResults = runSimulation();
                    displaySimulationResults(simulationResults);
                } catch (error) {
                    console.error("Error during simulation or display:", error);
                    alert("An error occurred during simulation. Please check the console for details.");
                }
            }


             // --- Product Performance Table Rendering ---
             function renderProductPerformanceTable(simulationData) {
                 if (!simulationData || !simulationData.customerCounts) {
                      productPerformanceTableContainer.innerHTML = '<p class="text-muted text-center">Run simulation to see performance.</p>';
                      return;
                 }

                 let tableHTML = `
                     <table class="table product-performance-table table-striped w-100">
                         <thead>
                             <tr>
                                 <th style="width: 22%">Product</th>
                                 <th style="width: 18%">Type</th>
                                 <th class="text-end" style="width: 15%">Price</th>
                                 <th class="text-end" style="width: 15%">Cost</th>
                                 <th class="text-end" style="width: 15%">Customers</th>
                                 <th class="text-end" style="width: 15%">Revenue</th>
                             </tr>
                         </thead>
                         <tbody>
                 `;

                 if (products.length === 0) {
                     tableHTML += '<tr><td colspan="6" class="text-center text-muted">No products defined.</td></tr>';
                 } else {
                     // Ensure products are sorted logically (e.g., Main, Bump, Upsell, Downsell, OTO)
                     const productOrder = ['Main Offer', 'Order Bump', 'Upsell 1', 'Downsell 1', 'OTO'];
                     products.sort((a, b) => {
                         const indexA = productOrder.indexOf(a.type);
                         const indexB = productOrder.indexOf(b.type);
                         // Handle types not in the predefined order if necessary
                         if (indexA === -1 && indexB === -1) return a.name.localeCompare(b.name);
                         if (indexA === -1) return 1;
                         if (indexB === -1) return -1;
                         return indexA - indexB;
                     });

                     // Calculate total revenue for adding percentage column
                     let totalTableRevenue = 0;
                     products.forEach(product => {
                         const customers = simulationData.customerCounts[product.type] || 0;
                         const revenue = customers * product.price;
                         if (revenue > 0) {
                             totalTableRevenue += revenue;
                         }
                     });
                     
                     products.forEach(product => {
                         const customers = simulationData.customerCounts[product.type] || 0;
                         const revenue = customers * product.price;
                         const revenuePercent = totalTableRevenue > 0 && revenue > 0 ? 
                             ((revenue / totalTableRevenue) * 100).toFixed(1) + '%' : '0%';
                         const isPositive = revenue > 0;
                         const isNegative = revenue < 0; // Should usually not happen unless price is negative

                         tableHTML += `
                             <tr>
                                 <td>${product.name}</td>
                                 <td>${product.type}</td>
                                 <td class="text-end">${formatCurrency(product.price)}</td>
                                 <td class="text-end">${formatCurrency(product.cost)}</td>
                                 <td class="text-end">${formatNumber(customers, 1)}</td>
                                 <td class="text-end revenue-value ${isPositive ? 'positive' : ''} ${isNegative ? 'negative' : ''}">
                                    ${formatCurrency(revenue)}
                                    ${revenue > 0 ? `<small class="text-muted">(${revenuePercent})</small>` : ''}
                                 </td>
                             </tr>
                         `;
                     });
                 }

                 tableHTML += `
                         </tbody>
                     </table>
                 `;
                 productPerformanceTableContainer.innerHTML = tableHTML;
             }


             // --- Sensitivity Analysis Logic ---
             function highlightSAMetric(selectedValue) {
                 sensitivityCurrentValueItems.forEach(item => {
                     item.classList.remove('sa-active-metric');
                     // Check dataset.metric, fallback to checking ID if dataset missing (shouldn't happen with current HTML)
                     const itemMetric = item.dataset.metric || item.id.replace('saCurrent', '').toLowerCase();
                     if (itemMetric === selectedValue) {
                         item.classList.add('sa-active-metric');
                     }
                 });
             }
             
             // Make current value items clickable
             sensitivityCurrentValueItems.forEach(item => {
                 item.style.cursor = 'pointer'; // Show clickable cursor
                 item.addEventListener('click', () => {
                     const metric = item.dataset.metric;
                     if (metric && saMetricSelect) {
                         // Set the dropdown to this metric
                         saMetricSelect.value = metric;
                         // Highlight this metric
                         highlightSAMetric(metric);
                         
                         // Get the current value from the element
                         const valueEl = item.querySelector('.value');
                         if (valueEl && saVariationInput) {
                             // Parse the current value, removing any currency symbols
                             let currentValue = valueEl.textContent.replace(/[^0-9.-]+/g, '');
                             currentValue = parseFloat(currentValue);
                             
                             // Set the variation input value based on the metric type
                             if (!isNaN(currentValue)) {
                                 if (metric === 'weeklyAdSpend' || metric === 'cpc' || metric === 'weeklyVisitors') {
                                     // For non-percentage metrics, default to a 10% increase
                                     saVariationInput.value = currentValue;
                                 } else {
                                     // For percentage metrics, use the actual value
                                     saVariationInput.value = currentValue;
                                 }
                             }
                         }
                     }
                 });
             });
             
             // Simple function to identify metric types (percentages, money, etc.)
             const getMetricType = (metric) => {
                 const percentageMetrics = ['optin', 'attendance', 'conversionCore', 'conversionBump', 'conversionUpsell', 'conversionDownsell', 'conversionOTO'];
                 if (percentageMetrics.includes(metric)) {
                     return 'percentage';
                 } else if (metric === 'weeklyAdSpend') {
                     return 'money';
                 } else if (metric === 'cpc') {
                     return 'money';
                 } else if (metric === 'weeklyVisitors') {
                     return 'visitors';
                 } else {
                     return 'other';
                 }
             };
             
             // Ensure saMetricSelect exists before adding listener
             if (saMetricSelect) {
                saMetricSelect.addEventListener('change', (e) => {
                    const metric = e.target.value;
                    highlightSAMetric(metric);
                });
             } else {
                console.warn("Sensitivity Analysis metric select element not found.");
             }

             // Ensure analyzeSensitivityBtn exists before adding listener
             if (analyzeSensitivityBtn) {
                 analyzeSensitivityBtn.addEventListener('click', () => {
                     // Use the *last* simulation results as the baseline "original"
                     // If no simulation ran, run one based on current inputs
                     const originalResults = lastSimulationResults || runSimulation();
                     if (!originalResults) {
                         alert("Please run an initial simulation first.");
                         return;
                     }

                     const metricToVary = saMetricSelect.value;
                     const variationValue = parseFloat(saVariationInput.value); // Get the value from input

                     if (isNaN(variationValue)) {
                        console.warn("Invalid variation value for Sensitivity Analysis.");
                        // Clear 'After Change' and 'Difference' columns
                        saAfterVisitors.textContent = '-'; saDiffVisitors.textContent = '-';
                        saAfterRevenue.textContent = '-'; saDiffRevenue.textContent = '-';
                        saAfterExpenses.textContent = '-'; saDiffExpenses.textContent = '-';
                        saAfterProdCosts.textContent = '-'; saDiffProdCosts.textContent = '-';
                        saAfterProfit.textContent = '-'; saDiffProfit.textContent = '-';
                        saAfterROI.textContent = '-'; saDiffROI.textContent = '-';
                        // Update chart with only original data
                        if (sensitivityComparisonChartInstance) {
                             sensitivityComparisonChartInstance.data.datasets[1].data = [0, 0, 0]; // Zero out 'After Change'
                             sensitivityComparisonChartInstance.update();
                        }
                        return;
                     }

                     let variedInputs = JSON.parse(JSON.stringify(originalResults.inputs)); // Deep copy of inputs from original run
                     const percentageMetrics = ['optin', 'attendance', 'conversionCore', 'conversionBump', 'conversionUpsell', 'conversionDownsell', 'conversionOTO'];
                     
                     console.log("Original Values:", {
                        weeklyAdSpend: originalResults.inputs.weeklyAdSpend,
                        cpc: originalResults.inputs.cpc,
                        weeklyVisitors: originalResults.flow.visitors,
                        rates: originalResults.inputs.rates
                     });
                     console.log("Varying Metric:", metricToVary, "with value:", variationValue);

                     // --- Determine the variation based on metric type ---
                     if (percentageMetrics.includes(metricToVary)) {
                         // For % rates, variationValue IS the NEW target percentage
                         let rateKey;
                         switch(metricToVary) {
                            case 'optin': rateKey = 'optin'; break;
                            case 'attendance': rateKey = 'attendance'; break;
                            case 'conversionCore': rateKey = 'coreConversion'; break;
                            case 'conversionBump': rateKey = 'bump'; break;
                            case 'conversionUpsell': rateKey = 'upsell'; break;
                            case 'conversionDownsell': rateKey = 'downsell'; break;
                            case 'conversionOTO': rateKey = 'oto'; break;
                         }
                         if (rateKey) {
                             // Set the rate directly to the input value, clamped between 0 and 100
                            variedInputs.rates[rateKey] = Math.max(0, Math.min(100, variationValue));
                            console.log(`Setting ${rateKey} rate to absolute value: ${variedInputs.rates[rateKey]}`);
                         }
                     } else if (metricToVary === 'weeklyVisitors') {
                         // For weekly visitors, we need to calculate the new CPC that would achieve this visitor count
                         // Since visitors = weeklyAdSpend / cpc, then cpc = weeklyAdSpend / visitors
                         const targetVisitors = variationValue;
                         if (targetVisitors > 0) {
                             // Keep ad spend the same, adjust CPC to achieve desired visitor count
                             variedInputs.cpc = variedInputs.weeklyAdSpend / targetVisitors;
                             console.log(`Setting CPC to ${variedInputs.cpc} to achieve ${targetVisitors} weekly visitors`);
                         }
                     } else {
                         // For absolute value metrics (spend, cpc), just set the value directly
                         if (metricToVary === 'weeklyAdSpend') {
                             variedInputs.weeklyAdSpend = Math.max(0, variationValue);
                             console.log(`Setting weekly ad spend to absolute value: ${variedInputs.weeklyAdSpend}`);
                         } else if (metricToVary === 'cpc') {
                             variedInputs.cpc = Math.max(0.01, variationValue);
                             console.log(`Setting CPC to absolute value: ${variedInputs.cpc}`);
                         }
                     }

                     // Run simulation with varied inputs
                     const afterResults = runSimulation(variedInputs);

                     // --- Update Sensitivity Table (Check if elements exist before updating) ---
                     const updateSAField = (origEl, afterEl, diffEl, origVal, afterVal, formatter, decimals = 2, diffFormatter = null, diffDecimals = null) => {
                        if (origEl) origEl.textContent = formatter(origVal, decimals);
                        if (afterEl) afterEl.textContent = formatter(afterVal, decimals);
                        if (diffEl) {
                            const diff = calculateDifference(origVal, afterVal);
                            const displayFormatter = diffFormatter || formatter;
                            const displayDecimals = diffDecimals !== null ? diffDecimals : decimals;
                            diffEl.textContent = `${displayFormatter(diff.absolute, displayDecimals)} ${diff.percentString}`;
                            applyFinancialStyle(diffEl, diff.absolute, true);
                        }
                     };

                     updateSAField(saOrigVisitors, saAfterVisitors, saDiffVisitors, originalResults.flow.visitors, afterResults.flow.visitors, formatNumber, 0, formatNumber, 0);
                     updateSAField(saOrigRevenue, saAfterRevenue, saDiffRevenue, originalResults.results.revenue, afterResults.results.revenue, formatCurrency);
                     updateSAField(saOrigExpenses, saAfterExpenses, saDiffExpenses, originalResults.results.expenses, afterResults.results.expenses, formatCurrency);
                     updateSAField(saOrigProdCosts, saAfterProdCosts, saDiffProdCosts, originalResults.results.productCosts, afterResults.results.productCosts, formatCurrency);
                     updateSAField(saOrigProfit, saAfterProfit, saDiffProfit, originalResults.results.profit, afterResults.results.profit, formatCurrency);

                     // Special handling for ROI
                     const origROIValue = isFinite(originalResults.results.roi) ? originalResults.results.roi : 0;
                     const afterROIValue = isFinite(afterResults.results.roi) ? afterResults.results.roi : 0;
                     if (saOrigROI) saOrigROI.textContent = isFinite(originalResults.results.roi) ? formatPercent(originalResults.results.roi) : 'INF%';
                     if (saAfterROI) saAfterROI.textContent = isFinite(afterResults.results.roi) ? formatPercent(afterResults.results.roi) : 'INF%';
                     if (saDiffROI) {
                        const diff = calculateDifference(origROIValue, afterROIValue); // % change of ROI value itself
                        const roiAbsDiff = afterROIValue - origROIValue; // Absolute percentage point difference
                        saDiffROI.textContent = `${(roiAbsDiff >= 0 ? '+' : '')}${roiAbsDiff.toFixed(2)}%p ${diff.percentString}`; // Show abs % points and % change
                        applyFinancialStyle(saDiffROI, roiAbsDiff, true);
                     }


                     // --- Update Sensitivity Comparison Chart ---
                     // This is now handled by the createCharts function called within displaySimulationResults
                     // Re-call createCharts to update the SA chart data based on the updated table values
                     createCharts(afterResults); // Pass afterResults to ensure latest data used if needed

                 });
            } else {
                console.warn("Analyze Sensitivity button not found.");
            }


             // --- Dream Profit Goal Logic ---
             if (calculateDreamProfitBtn) {
                 calculateDreamProfitBtn.addEventListener('click', () => {
                     const annualGoal = parseFloat(dreamProfitInput.value) || 0;
                     dpgHeaderAmount.textContent = formatCurrency(annualGoal);

                     // Use the *last* simulation results as the basis, run if needed
                     const currentSim = lastSimulationResults || runSimulation();
                     if (!currentSim || currentSim.results.profit === undefined) {
                        console.warn("Dream Profit: Cannot calculate without valid current simulation results.");
                         // Clear Dream Profit Table
                        const clearCell = (elId) => { const el = document.getElementById(elId); if (el) el.textContent = '-'; };
                        clearCell('dpgDayRevenue'); clearCell('dpgWeekRevenue'); clearCell('dpgMonthRevenue'); clearCell('dpgYearRevenue');
                        clearCell('dpgDayProfit'); clearCell('dpgWeekProfit'); clearCell('dpgMonthProfit'); clearCell('dpgYearProfit');
                        clearCell('dpgDayTraffic'); clearCell('dpgWeekTraffic'); clearCell('dpgMonthTraffic'); clearCell('dpgYearTraffic');
                        clearCell('dpgDayCost'); clearCell('dpgWeekCost'); clearCell('dpgMonthCost'); clearCell('dpgYearCost');
                        clearCell('dpgDayLeads'); clearCell('dpgWeekLeads'); clearCell('dpgMonthLeads'); clearCell('dpgYearLeads');
                        return;
                     }

                     // Calculate time period constants
                     const weeksPerYear = 365.25 / 7;
                     const weeksPerMonth = weeksPerYear / 12;
                     const daysPerYear = 365.25;
                     
                     // Current performance metrics
                     const currentWeeklyProfit = currentSim.results.profit;
                     const currentWeeklyRevenue = currentSim.results.revenue;
                     const currentWeeklyAdSpend = currentSim.inputs.weeklyAdSpend;
                     const currentWeeklyVisitors = currentSim.flow.visitors;
                     const currentWeeklyLeads = currentSim.flow.optins;
                     const currentProfitMargin = currentWeeklyProfit / currentWeeklyRevenue;
                     
                     // Convert to annual figures
                     const currentAnnualProfit = currentWeeklyProfit * weeksPerYear;
                     
                     console.log('Current Performance:', {
                         currentWeeklyProfit,
                         currentWeeklyRevenue,
                         currentAnnualProfit,
                         currentProfitMargin,
                         currentWeeklyVisitors
                     });
                     
                     // Calculate scale factor from current to desired profit
                     let scaleFactor = 0;
                     if (currentAnnualProfit > 0 && annualGoal > 0) {
                         // How much more profit we need
                         scaleFactor = annualGoal / currentAnnualProfit;
                     } else if (annualGoal <= 0) {
                         scaleFactor = 0;
                     } else if (currentAnnualProfit <= 0 && annualGoal > 0) {
                         // Can't scale from negative/zero profit
                         scaleFactor = 1; // Use current performance but show it won't reach goal
                         console.warn("Dream Profit: Cannot scale from zero/negative current profit to reach a positive goal.");
                     }
                     
                     // Calculate required metrics to reach goal, preserving the relationships in the funnel
                     // We scale traffic (and costs) by the same factor to maintain conversion rates
                     const reqWeeklyVisitors = currentWeeklyVisitors * scaleFactor;
                     const reqCpc = currentSim.inputs.cpc; // CPC stays the same
                     const reqWeeklyAdSpend = reqWeeklyVisitors * reqCpc;
                     
                     // Create inputs for a new simulation with scaled ad spend
                     let dreamInputs = JSON.parse(JSON.stringify(currentSim.inputs));
                     dreamInputs.weeklyAdSpend = reqWeeklyAdSpend;

                     // Run the simulation with the scaled inputs
                     const dreamSim = runSimulation(dreamInputs);

                     // Extract results from the dream simulation
                     const reqWeeklyRevenue = dreamSim.results.revenue;
                     const reqWeeklyProfit = dreamSim.results.profit; // Should be close to annualGoal / weeksPerYear
                     const reqWeeklyLeads = dreamSim.flow.optins;
                     
                     // Verify the goal was achieved (accounting for minor rounding errors)
                     const annualProfitAchieved = reqWeeklyProfit * weeksPerYear;
                     const goalAccuracy = (annualProfitAchieved / annualGoal) * 100;
                     
                     console.log('Dream Goal Results:', {
                         annualGoal,
                         annualProfitAchieved,
                         goalAccuracy: goalAccuracy.toFixed(2) + '%',
                         scaleFactor,
                         weeksPerYear
                     });
                     
                     // Create status message to display in the header
                     if (currentAnnualProfit <= 0 && annualGoal > 0) {
                         // Show warning that goal can't be achieved from current performance
                         dpgHeaderAmount.innerHTML = `${formatCurrency(annualGoal)} <small class="text-danger">(Can't calculate from current performance)</small>`;
                     } else if (Math.abs(goalAccuracy - 100) > 5) {
                         // If more than 5% off, add a note
                         dpgHeaderAmount.innerHTML = `${formatCurrency(annualGoal)} <small class="text-muted">(Achievable with ${scaleFactor.toFixed(1)}x traffic)</small>`;
                     } else {
                         dpgHeaderAmount.textContent = formatCurrency(annualGoal);
                     }

                     // Constants were already defined above

                     const updateDpgRow = (prefix, weeklyValue, formatter, decimals = 2) => {
                        const yearVal = weeklyValue * weeksPerYear;
                        const monthVal = yearVal / 12;
                        const dayVal = yearVal / daysPerYear;
                        
                        // Safely update elements with null checks
                        const safeUpdateElement = (id, value) => {
                            const element = document.getElementById(id);
                            if (element) {
                                element.textContent = value;
                                return element;
                            }
                            return null;
                        };
                        
                        // For metrics like Revenue, Profit, etc., combine with their prefixes
                        const yearElement = safeUpdateElement(`${prefix}Year`, formatter(yearVal, decimals));
                        const monthElement = safeUpdateElement(`${prefix}Month`, formatter(monthVal, decimals));
                        const weekElement = safeUpdateElement(`${prefix}Week`, formatter(weeklyValue, decimals));
                        const dayElement = safeUpdateElement(`${prefix}Day`, formatter(dayVal, decimals));
                        
                        // Apply financial styling if needed
                        if (prefix === 'dpgDayProfit' || prefix === 'dpgWeekProfit' || prefix === 'dpgMonthProfit' || prefix === 'dpgYearProfit' ||
                            prefix === 'dpgDayRevenue' || prefix === 'dpgWeekRevenue' || prefix === 'dpgMonthRevenue' || prefix === 'dpgYearRevenue') {
                            if (dayElement) applyFinancialStyle(dayElement, dayVal);
                            if (weekElement) applyFinancialStyle(weekElement, weeklyValue);
                            if (monthElement) applyFinancialStyle(monthElement, monthVal);
                            if (yearElement) applyFinancialStyle(yearElement, yearVal);
                        }
                     };

                     // Revenue
                     console.log('Dream Profit Goal Calculation:', {
                        currentWeeklyProfit,
                        annualGoal,
                        scaleFactor,
                        reqWeeklyVisitors,
                        reqWeeklyAdSpend,
                        reqWeeklyRevenue,
                        reqWeeklyProfit,
                        reqWeeklyLeads
                     });
                     
                     // Update table cells directly
                     // Day calculations (annual / 365.25)
                     if (dpgDayRevenue) dpgDayRevenue.textContent = formatCurrency(reqWeeklyRevenue * weeksPerYear / 365.25);
                     if (dpgDayProfit) dpgDayProfit.textContent = formatCurrency(reqWeeklyProfit * weeksPerYear / 365.25);
                     if (dpgDayTraffic) dpgDayTraffic.textContent = formatNumber(reqWeeklyVisitors * weeksPerYear / 365.25, 0);
                     if (dpgDayCost) dpgDayCost.textContent = formatCurrency(reqWeeklyAdSpend * weeksPerYear / 365.25);
                     if (dpgDayLeads) dpgDayLeads.textContent = formatNumber(reqWeeklyLeads * weeksPerYear / 365.25, 0);
                     
                     // Week calculations (direct weekly values)
                     if (dpgWeekRevenue) dpgWeekRevenue.textContent = formatCurrency(reqWeeklyRevenue);
                     if (dpgWeekProfit) dpgWeekProfit.textContent = formatCurrency(reqWeeklyProfit);
                     if (dpgWeekTraffic) dpgWeekTraffic.textContent = formatNumber(reqWeeklyVisitors, 0);
                     if (dpgWeekCost) dpgWeekCost.textContent = formatCurrency(reqWeeklyAdSpend);
                     if (dpgWeekLeads) dpgWeekLeads.textContent = formatNumber(reqWeeklyLeads, 0);
                     
                     // Month calculations (weekly * 4.35)
                     if (dpgMonthRevenue) dpgMonthRevenue.textContent = formatCurrency(reqWeeklyRevenue * weeksPerMonth);
                     if (dpgMonthProfit) dpgMonthProfit.textContent = formatCurrency(reqWeeklyProfit * weeksPerMonth);
                     if (dpgMonthTraffic) dpgMonthTraffic.textContent = formatNumber(reqWeeklyVisitors * weeksPerMonth, 0);
                     if (dpgMonthCost) dpgMonthCost.textContent = formatCurrency(reqWeeklyAdSpend * weeksPerMonth);
                     if (dpgMonthLeads) dpgMonthLeads.textContent = formatNumber(reqWeeklyLeads * weeksPerMonth, 0);
                     
                     // Year calculations (weekly * 52.18)
                     if (dpgYearRevenue) dpgYearRevenue.textContent = formatCurrency(reqWeeklyRevenue * weeksPerYear);
                     if (dpgYearProfit) dpgYearProfit.textContent = formatCurrency(reqWeeklyProfit * weeksPerYear);
                     if (dpgYearTraffic) dpgYearTraffic.textContent = formatNumber(reqWeeklyVisitors * weeksPerYear, 0);
                     if (dpgYearCost) dpgYearCost.textContent = formatCurrency(reqWeeklyAdSpend * weeksPerYear);
                     if (dpgYearLeads) dpgYearLeads.textContent = formatNumber(reqWeeklyLeads * weeksPerYear, 0);
                     
                     // Apply styles
                     const applyStyles = (element, value) => {
                         if (element) {
                             applyFinancialStyle(element, value);
                         }
                     };
                     
                     // Apply financial styling to revenue and profit cells
                     applyStyles(dpgDayRevenue, reqWeeklyRevenue);
                     applyStyles(dpgWeekRevenue, reqWeeklyRevenue);
                     applyStyles(dpgMonthRevenue, reqWeeklyRevenue);
                     applyStyles(dpgYearRevenue, reqWeeklyRevenue);
                     
                     applyStyles(dpgDayProfit, reqWeeklyProfit);
                     applyStyles(dpgWeekProfit, reqWeeklyProfit);
                     applyStyles(dpgMonthProfit, reqWeeklyProfit);
                     applyStyles(dpgYearProfit, reqWeeklyProfit);

                     // Manual assignment (alternative if helper function is confusing)
                     /*
                     // Revenue
                     const reqYearRevenue = reqWeeklyRevenue * weeksPerYear;
                     dpgYearRevenue.textContent = formatCurrency(reqYearRevenue);
                     dpgMonthRevenue.textContent = formatCurrency(reqYearRevenue / 12);
                     dpgWeekRevenue.textContent = formatCurrency(reqWeeklyRevenue);
                     dpgDayRevenue.textContent = formatCurrency(reqYearRevenue / daysPerYear);
                     applyFinancialStyle(dpgDayRevenue, reqYearRevenue / daysPerYear); applyFinancialStyle(dpgWeekRevenue, reqWeeklyRevenue); applyFinancialStyle(dpgMonthRevenue, reqYearRevenue / 12); applyFinancialStyle(dpgYearRevenue, reqYearRevenue);

                     // Profit
                     const reqYearProfit = reqWeeklyProfit * weeksPerYear;
                     dpgYearProfit.textContent = formatCurrency(reqYearProfit);
                     dpgMonthProfit.textContent = formatCurrency(reqYearProfit / 12);
                     dpgWeekProfit.textContent = formatCurrency(reqWeeklyProfit);
                     dpgDayProfit.textContent = formatCurrency(reqYearProfit / daysPerYear);
                     applyFinancialStyle(dpgDayProfit, reqYearProfit / daysPerYear); applyFinancialStyle(dpgWeekProfit, reqWeeklyProfit); applyFinancialStyle(dpgMonthProfit, reqYearProfit / 12); applyFinancialStyle(dpgYearProfit, reqYearProfit);

                     // Visitors (Traffic)
                     const reqYearTraffic = reqWeeklyVisitors * weeksPerYear;
                     dpgYearTraffic.textContent = formatNumber(reqYearTraffic, 0);
                     dpgMonthTraffic.textContent = formatNumber(reqYearTraffic / 12, 0);
                     dpgWeekTraffic.textContent = formatNumber(reqWeeklyVisitors, 0);
                     dpgDayTraffic.textContent = formatNumber(reqYearTraffic / daysPerYear, 0);

                     // Cost (Ad Spend)
                     const reqYearCost = reqWeeklyAdSpend * weeksPerYear;
                     dpgYearCost.textContent = formatCurrency(reqYearCost);
                     dpgMonthCost.textContent = formatCurrency(reqYearCost / 12);
                     dpgWeekCost.textContent = formatCurrency(reqWeeklyAdSpend);
                     dpgDayCost.textContent = formatCurrency(reqYearCost / daysPerYear);

                      // Leads (Registrations)
                     const reqYearLeads = reqWeeklyLeads * weeksPerYear;
                     dpgYearLeads.textContent = formatNumber(reqYearLeads, 0);
                     dpgMonthLeads.textContent = formatNumber(reqYearLeads / 12, 0);
                     dpgWeekLeads.textContent = formatNumber(reqWeeklyLeads, 0);
                     dpgDayLeads.textContent = formatNumber(reqYearLeads / daysPerYear, 0);
                     */
                 });
            } else {
                console.warn("Calculate Dream Profit button not found.");
            }


            // --- Sidebar Input Listeners ---
            function updateCalculatedVisitors() {
                 if (!weeklyAdSpendInput || !cpcInput || !weeklyVisitorsInput) return; // Check if elements exist
                 const spend = parseFloat(weeklyAdSpendInput.value) || 0;
                 const cpc = parseFloat(cpcInput.value) || 0.01; // Ensure cpc is never 0
                 const visitors = (cpc > 0) ? Math.round(spend / cpc) : 0;
                 weeklyVisitorsInput.value = visitors;
             }
             // Update visitor calculation display immediately on input
             if (weeklyAdSpendInput) weeklyAdSpendInput.addEventListener('input', updateCalculatedVisitors);
             if (cpcInput) cpcInput.addEventListener('input', updateCalculatedVisitors);


             // --- Modal: Expenses ---
             const expenseModalElement = document.getElementById('expenseModal');
             const expenseForm = document.getElementById('addExpenseForm');
             const expenseNameInput = document.getElementById('expenseName');
             const expenseAmountInput = document.getElementById('expenseAmount');
             const expenseFrequencyInput = document.getElementById('expenseFrequency');
             const currentExpensesList = document.getElementById('currentExpensesList');
             const noOtherExpensesText = document.getElementById('noOtherExpensesText');
             const editExpenseIdInput = document.getElementById('editExpenseId');
             const addExpenseBtn = document.getElementById('addExpenseBtn');
             const cancelEditExpenseBtn = document.getElementById('cancelEditExpenseBtn');

             function renderExpenses() {
                 if (!currentExpensesList || !noOtherExpensesText || !weeklyAdSpendInput) return; // Ensure elements exist
                 currentExpensesList.innerHTML = '';
                 let hasOtherExpenses = false;
                 // Display current Ad Spend (read-only)
                 const adSpend = parseFloat(weeklyAdSpendInput.value) || 0;
                 const adSpendItem = document.createElement('div');
                 adSpendItem.className = 'list-group-item readonly-item';
                 adSpendItem.innerHTML = `
                     <div class="item-details"><strong>Weekly Advertising</strong><span>${formatCurrency(adSpend)} | Weekly (Auto)</span></div>
                     <div class="item-actions"></div>`; // No actions for auto item
                 currentExpensesList.appendChild(adSpendItem);

                 // Add user-defined expenses
                 expenses.forEach(exp => {
                    hasOtherExpenses = true;
                     const item = document.createElement('div'); item.className = 'list-group-item'; item.dataset.id = exp.id;
                     item.innerHTML = `<div class="item-details"><strong>${exp.name}</strong><span>${formatCurrency(exp.amount)} | ${exp.frequency}</span></div><div class="item-actions"><button class="btn btn-sm btn-outline-primary me-1 btn-edit-expense"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-outline-danger btn-delete-expense"><i class="fas fa-trash"></i></button></div>`;
                     currentExpensesList.appendChild(item);
                 });
                 noOtherExpensesText.style.display = hasOtherExpenses ? 'none' : 'block';
                 // Add event listeners to new buttons
                 currentExpensesList.querySelectorAll('.btn-edit-expense').forEach(btn => btn.addEventListener('click', handleEditExpense));
                 currentExpensesList.querySelectorAll('.btn-delete-expense').forEach(btn => btn.addEventListener('click', handleDeleteExpense));
            }

             if (expenseForm) {
                expenseForm.addEventListener('submit', (e) => {
                     e.preventDefault();
                     if (!editExpenseIdInput || !expenseNameInput || !expenseAmountInput || !expenseFrequencyInput || !addExpenseBtn || !cancelEditExpenseBtn) return;

                     const id = editExpenseIdInput.value;
                     const expenseData = { id: id ? parseInt(id) : Date.now(), name: expenseNameInput.value.trim(), amount: parseFloat(expenseAmountInput.value) || 0, frequency: expenseFrequencyInput.value };

                     if (!expenseData.name || expenseData.amount <= 0) { alert('Please provide a valid name and positive amount.'); return; }

                     if (id) { // Editing existing
                        expenses = expenses.map(exp => exp.id === expenseData.id ? expenseData : exp);
                     } else { // Adding new
                        expenses.push(expenseData);
                     }
                     renderExpenses();
                     resetExpenseForm();
                     // DO NOT run full simulation here, user clicks Simulate button
                });
            }

             function handleEditExpense(e) {
                if (!editExpenseIdInput || !expenseNameInput || !expenseAmountInput || !expenseFrequencyInput || !addExpenseBtn || !cancelEditExpenseBtn) return;
                const item = e.target.closest('.list-group-item');
                if (!item || !item.dataset.id) return;
                const id = parseInt(item.dataset.id);
                const expense = expenses.find(exp => exp.id === id);
                if (expense) {
                    editExpenseIdInput.value = expense.id;
                    expenseNameInput.value = expense.name;
                    expenseAmountInput.value = expense.amount;
                    expenseFrequencyInput.value = expense.frequency;
                    addExpenseBtn.textContent = 'Update Expense';
                    cancelEditExpenseBtn.style.display = 'block';
                }
            }

             function handleDeleteExpense(e) {
                const item = e.target.closest('.list-group-item');
                 if (!item || !item.dataset.id) return;
                const id = parseInt(item.dataset.id);
                const expense = expenses.find(exp => exp.id === id); // Find for confirmation message
                if (expense && confirm(`Are you sure you want to delete expense "${expense.name}"?`)) {
                    expenses = expenses.filter(exp => exp.id !== id);
                    renderExpenses();
                    // DO NOT run full simulation here
                }
            }

             function resetExpenseForm() {
                 if (!editExpenseIdInput || !expenseForm || !addExpenseBtn || !cancelEditExpenseBtn) return;
                editExpenseIdInput.value = '';
                expenseForm.reset();
                addExpenseBtn.textContent = 'Add Expense';
                cancelEditExpenseBtn.style.display = 'none';
            }

            if (cancelEditExpenseBtn) cancelEditExpenseBtn.addEventListener('click', resetExpenseForm);
            if (expenseModalElement) {
                expenseModalElement.addEventListener('show.bs.modal', renderExpenses);
                expenseModalElement.addEventListener('hidden.bs.modal', resetExpenseForm);
            }


             // --- Modal: Products ---
             const productModalElement = document.getElementById('productModal');
             const productForm = document.getElementById('addProductForm');
             const productNameInput = document.getElementById('productName');
             const productTypeInput = document.getElementById('productType');
             const productPriceInput = document.getElementById('productPrice');
             const productCostInput = document.getElementById('productCost');
             const currentProductsList = document.getElementById('currentProductsList');
             const noProductsText = document.getElementById('noProductsText');
             const editProductIdInput = document.getElementById('editProductId');
             const addProductBtn = document.getElementById('addProductBtn');
             const cancelEditProductBtn = document.getElementById('cancelEditProductBtn');

             function renderProducts() {
                 if (!currentProductsList || !noProductsText) return; // Check elements exist
                 currentProductsList.innerHTML = '';
                 // Sort products before rendering
                 const productOrder = ['Main Offer', 'Order Bump', 'Upsell 1', 'Downsell 1', 'OTO'];
                 products.sort((a, b) => {
                         const indexA = productOrder.indexOf(a.type);
                         const indexB = productOrder.indexOf(b.type);
                         if (indexA === -1 && indexB === -1) return a.name.localeCompare(b.name);
                         if (indexA === -1) return 1;
                         if (indexB === -1) return -1;
                         return indexA - indexB;
                     });

                 products.forEach(prod => {
                    const item = document.createElement('div'); item.className = 'list-group-item'; item.dataset.id = prod.id;
                    item.innerHTML = `<div class="item-details"><strong>${prod.name} (${prod.type})</strong><span>Price: ${formatCurrency(prod.price)} | Cost: ${formatCurrency(prod.cost)}</span></div><div class="item-actions"><button class="btn btn-sm btn-outline-primary me-1 btn-edit-product"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-outline-danger btn-delete-product"><i class="fas fa-trash"></i></button></div>`;
                    currentProductsList.appendChild(item);
                 });
                 noProductsText.style.display = products.length === 0 ? 'block' : 'none';
                 // Add listeners to new buttons
                 currentProductsList.querySelectorAll('.btn-edit-product').forEach(btn => btn.addEventListener('click', handleEditProduct));
                 currentProductsList.querySelectorAll('.btn-delete-product').forEach(btn => btn.addEventListener('click', handleDeleteProduct));
             }

            if (productForm) {
                 productForm.addEventListener('submit', (e) => {
                     e.preventDefault();
                      if (!editProductIdInput || !productNameInput || !productTypeInput || !productPriceInput || !productCostInput || !addProductBtn || !cancelEditProductBtn) return;

                     const id = editProductIdInput.value;
                     const productData = { id: id ? parseInt(id) : Date.now(), name: productNameInput.value.trim(), type: productTypeInput.value, price: parseFloat(productPriceInput.value) || 0, cost: parseFloat(productCostInput.value) || 0 };

                     if (!productData.name || !productData.type || productData.price < 0 || productData.cost < 0) { alert('Please provide a valid name, type, and non-negative price/cost.'); return; }

                     const isEditing = !!id;
                     const existingProductOfSameType = products.find(p => p.type === productData.type && p.id !== productData.id);

                     // Prevent adding duplicate TYPE, allow editing existing
                     if (!isEditing && existingProductOfSameType) {
                          alert(`A product of type '${productData.type}' already exists. You can only have one product per type. Edit the existing one or delete it first.`);
                          return;
                     }

                     if (isEditing) { // Update existing
                        products = products.map(prod => prod.id === productData.id ? productData : prod);
                     } else { // Add new
                        products.push(productData);
                     }
                     renderProducts();
                     resetProductForm();
                     // DO NOT run full simulation here
                 });
            }

             function handleEditProduct(e) {
                 if (!editProductIdInput || !productNameInput || !productTypeInput || !productPriceInput || !productCostInput || !addProductBtn || !cancelEditProductBtn) return;
                const item = e.target.closest('.list-group-item');
                 if (!item || !item.dataset.id) return;
                const id = parseInt(item.dataset.id);
                const product = products.find(prod => prod.id === id);
                if (product) {
                    editProductIdInput.value = product.id;
                    productNameInput.value = product.name;
                    productTypeInput.value = product.type;
                    productPriceInput.value = product.price;
                    productCostInput.value = product.cost;
                    addProductBtn.textContent = 'Update Product';
                    cancelEditProductBtn.style.display = 'block';
                    productTypeInput.disabled = true; // Prevent changing type during edit
                }
            }

             function handleDeleteProduct(e) {
                const item = e.target.closest('.list-group-item');
                 if (!item || !item.dataset.id) return;
                const id = parseInt(item.dataset.id);
                const product = products.find(prod => prod.id === id);
                if (product && confirm(`Are you sure you want to delete product "${product.name}"?`)) {
                    products = products.filter(prod => prod.id !== id);
                    renderProducts();
                    // DO NOT run full simulation here
                }
            }

              function resetProductForm() {
                 if (!editProductIdInput || !productForm || !productCostInput || !addProductBtn || !cancelEditProductBtn || !productTypeInput) return;
                editProductIdInput.value = '';
                productForm.reset();
                productCostInput.value = 0; // Explicitly reset cost to 0
                addProductBtn.textContent = 'Add Product';
                cancelEditProductBtn.style.display = 'none';
                productTypeInput.disabled = false; // Re-enable type for adding
            }

            if (cancelEditProductBtn) cancelEditProductBtn.addEventListener('click', resetProductForm);
            if (productModalElement) {
                productModalElement.addEventListener('show.bs.modal', renderProducts);
                productModalElement.addEventListener('hidden.bs.modal', resetProductForm);
            }

             // --- Scroll-to-Top Button Logic ---
             if (scrollTopBtn) {
                 window.addEventListener('scroll', () => {
                    if (window.pageYOffset > 300) { scrollTopBtn.style.display = 'flex'; } else { scrollTopBtn.style.display = 'none'; } });
                 scrollTopBtn.addEventListener('click', () => {
                    window.scrollTo({ top: 0, behavior: 'smooth' }); });
            }


            // --- Navbar Buttons ---
            const simulateBtn = document.getElementById('simulateBtn');
            if (simulateBtn) {
                simulateBtn.addEventListener('click', function() {
                    console.log('Simulate button clicked');
                    runSimulationAndDisplay(); // Run simulation and update display
                    const btn = this; btn.disabled = true; // Briefly disable
                    btn.innerHTML = '<i class="fas fa-check"></i> Simulated!';
                    setTimeout(() => { btn.innerHTML = '<i class="fas fa-play me-1"></i> Simulate'; btn.disabled = false; }, 1500);
                });
            }

            // PDF Export Functionality
            const pdfBtn = document.getElementById('pdfBtn');
            if (pdfBtn) {
                pdfBtn.addEventListener('click', function() {
                    if (!lastSimulationResults) {
                        alert('Please run a simulation first before generating a PDF.');
                        return;
                    }
                    
                    // Show loading indicator
                    pdfBtn.disabled = true;
                    pdfBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
                    
                    // Access the jsPDF library from the UMD global
                    const { jsPDF } = window.jspdf;
                    
                    // Create a new PDF document
                    const doc = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: 'a4'
                    });
                    
                    // Set title
                    doc.setFontSize(22);
                    doc.text('Webinar Funnel Simulation Report', 15, 15);
                    doc.setFontSize(12);
                    doc.text(`Generated: ${new Date().toLocaleString()}`, 15, 22);
                    doc.setLineWidth(0.5);
                    doc.line(15, 25, 195, 25);
                    
                    // Get content to capture
                    const mainContent = document.getElementById('main-content');
                    if (!mainContent) {
                        alert('Could not find main content to export.');
                        pdfBtn.disabled = false;
                        pdfBtn.innerHTML = '<i class="fas fa-file-pdf me-1"></i> PDF';
                        return;
                    }
                    
                    // Function to add charts and tables to the PDF
                    async function captureAndAddContent() {
                        try {
                            let yPos = 30;
                            const margin = 15;
                            const pageWidth = 210 - (margin * 2); // A4 width minus margins
                            
                            // Add simulation results
                            doc.setFontSize(16);
                            doc.text('Simulation Results', margin, yPos);
                            yPos += 10;
                            
                            // Create a data table for simulation results
                            const resultData = [
                                ['Metric', 'Value'],
                                ['Weekly Revenue', formatCurrency(lastSimulationResults.results.revenue)],
                                ['Weekly Expenses', formatCurrency(lastSimulationResults.results.expenses)],
                                ['Weekly Profit', formatCurrency(lastSimulationResults.results.profit)],
                                ['ROI', isFinite(lastSimulationResults.results.roi) ? formatPercent(lastSimulationResults.results.roi) : 'INF%'],
                                ['Weekly Visitors', formatNumber(lastSimulationResults.flow.visitors)],
                                ['Weekly Opt-ins', formatNumber(lastSimulationResults.flow.optins)],
                                ['Weekly Attendees', formatNumber(lastSimulationResults.flow.attendees)],
                                ['Weekly Customers', formatNumber(lastSimulationResults.flow.customers)]
                            ];
                            
                            // Draw the table
                            doc.autoTable({
                                startY: yPos,
                                head: [resultData[0]],
                                body: resultData.slice(1),
                                theme: 'striped',
                                margin: { left: margin, right: margin },
                                headStyles: { fillColor: [106, 17, 203] }
                            });
                            
                            yPos = doc.lastAutoTable.finalY + 15;
                            
                            // Add funnel stages chart
                            if (document.getElementById('funnelStagesChart')) {
                                doc.setFontSize(16);
                                doc.text('Funnel Stages', margin, yPos);
                                yPos += 10;
                                
                                // Convert chart to image
                                const funnelStagesCanvas = document.getElementById('funnelStagesChart');
                                const funnelStagesImg = funnelStagesCanvas.toDataURL('image/png');
                                
                                // Add image to PDF (centered, with appropriate size)
                                const imgWidth = pageWidth * 0.8; // 80% of page width
                                const imgHeight = (imgWidth * funnelStagesCanvas.height) / funnelStagesCanvas.width;
                                const xPos = margin + (pageWidth - imgWidth) / 2;
                                
                                doc.addImage(funnelStagesImg, 'PNG', xPos, yPos, imgWidth, imgHeight);
                                yPos += imgHeight + 15;
                            }
                            
                            // Check if we need a new page for revenue breakdown
                            if (yPos > 240) { // Close to bottom of page
                                doc.addPage();
                                yPos = 15;
                            }
                            
                            // Add revenue breakdown chart
                            if (document.getElementById('revenueBreakdownChart')) {
                                doc.setFontSize(16);
                                doc.text('Revenue Distribution by Product', margin, yPos);
                                yPos += 10;
                                
                                // Convert chart to image
                                const revenueChart = document.getElementById('revenueBreakdownChart');
                                const revenueImg = revenueChart.toDataURL('image/png');
                                
                                // Add image to PDF
                                const imgWidth = pageWidth * 0.8;
                                const imgHeight = (imgWidth * revenueChart.height) / revenueChart.width;
                                const xPos = margin + (pageWidth - imgWidth) / 2;
                                
                                doc.addImage(revenueImg, 'PNG', xPos, yPos, imgWidth, imgHeight);
                                yPos += imgHeight + 15;
                            }
                            
                            // Check if we need a new page for product performance
                            if (yPos > 240) {
                                doc.addPage();
                                yPos = 15;
                            }
                            
                            // Add product performance table
                            doc.setFontSize(16);
                            doc.text('Product Performance', margin, yPos);
                            yPos += 10;
                            
                            // Build table data from products and simulation results
                            const tableHeaders = ['Product', 'Type', 'Price', 'Cost', 'Customers', 'Revenue'];
                            const tableRows = [];
                            
                            // Sort products as in the table
                            const productOrder = ['Main Offer', 'Order Bump', 'Upsell 1', 'Downsell 1', 'OTO'];
                            const sortedProducts = [...products].sort((a, b) => {
                                const indexA = productOrder.indexOf(a.type);
                                const indexB = productOrder.indexOf(b.type);
                                if (indexA === -1 && indexB === -1) return a.name.localeCompare(b.name);
                                if (indexA === -1) return 1;
                                if (indexB === -1) return -1;
                                return indexA - indexB;
                            });
                            
                            // Add products to table
                            sortedProducts.forEach(product => {
                                const customers = lastSimulationResults.customerCounts[product.type] || 0;
                                const revenue = customers * product.price;
                                tableRows.push([
                                    product.name,
                                    product.type,
                                    formatCurrency(product.price),
                                    formatCurrency(product.cost),
                                    formatNumber(customers, 1),
                                    formatCurrency(revenue)
                                ]);
                            });
                            
                            // Draw the product table
                            doc.autoTable({
                                startY: yPos,
                                head: [tableHeaders],
                                body: tableRows,
                                theme: 'striped',
                                margin: { left: margin, right: margin },
                                headStyles: { fillColor: [106, 17, 203] }
                            });
                            
                            yPos = doc.lastAutoTable.finalY + 15;
                            
                            // Check if we need a new page for sensitivity analysis
                            if (yPos > 240) {
                                doc.addPage();
                                yPos = 15;
                            }
                            
                            // Add Sensitivity Analysis chart if it exists
                            if (document.getElementById('sensitivityComparisonChart')) {
                                doc.setFontSize(16);
                                doc.text('Sensitivity Analysis', margin, yPos);
                                yPos += 10;
                                
                                // Convert SA chart to image
                                const saChart = document.getElementById('sensitivityComparisonChart');
                                const saImg = saChart.toDataURL('image/png');
                                
                                // Add image to PDF
                                const imgWidth = pageWidth * 0.8;
                                const imgHeight = (imgWidth * saChart.height) / saChart.width;
                                const xPos = margin + (pageWidth - imgWidth) / 2;
                                
                                doc.addImage(saImg, 'PNG', xPos, yPos, imgWidth, imgHeight);
                                yPos += imgHeight + 15;
                                
                                // Get current values from SA
                                const saCurrentValues = [];
                                document.querySelectorAll('.sensitivity-current-values .current-value-item').forEach(item => {
                                    const label = item.querySelector('.label')?.textContent || '';
                                    const value = item.querySelector('.value')?.textContent || '';
                                    if (label && value) {
                                        saCurrentValues.push([label, value]);
                                    }
                                });
                                
                                // Add SA current values table if we have data
                                if (saCurrentValues.length > 0) {
                                    doc.setFontSize(14);
                                    doc.text('Current Values:', margin, yPos);
                                    yPos += 5;
                                    
                                    doc.autoTable({
                                        startY: yPos,
                                        body: saCurrentValues,
                                        theme: 'plain',
                                        margin: { left: margin, right: margin }
                                    });
                                    
                                    yPos = doc.lastAutoTable.finalY + 10;
                                }
                                
                                // Get SA result table
                                const saTableRows = [];
                                const saTableHeaders = ['Metric', 'Original', 'After Change', 'Difference'];
                                
                                // Helper to get table cell content
                                const getCellContent = (row, cellIndex) => {
                                    const cell = row.cells[cellIndex];
                                    return cell ? cell.textContent.trim() : '';
                                };
                                
                                // Extract SA result table data
                                const saTable = document.querySelector('.sa-table');
                                if (saTable && saTable.rows.length > 1) {
                                    for (let i = 1; i < saTable.rows.length; i++) { // Skip header row
                                        const row = saTable.rows[i];
                                        if (row.cells.length >= 4) {
                                            saTableRows.push([
                                                getCellContent(row, 0),
                                                getCellContent(row, 1),
                                                getCellContent(row, 2),
                                                getCellContent(row, 3)
                                            ]);
                                        }
                                    }
                                }
                                
                                // Add SA result table if we have data
                                if (saTableRows.length > 0) {
                                    // Check if we need a new page
                                    if (yPos > 240) {
                                        doc.addPage();
                                        yPos = 15;
                                    }
                                    
                                    doc.setFontSize(14);
                                    doc.text('Sensitivity Analysis Results:', margin, yPos);
                                    yPos += 5;
                                    
                                    doc.autoTable({
                                        startY: yPos,
                                        head: [saTableHeaders],
                                        body: saTableRows,
                                        theme: 'striped',
                                        margin: { left: margin, right: margin },
                                        headStyles: { fillColor: [106, 17, 203] }
                                    });
                                    
                                    yPos = doc.lastAutoTable.finalY + 15;
                                }
                            }
                            
                            // Check if we need a new page for Dream Profit Goal
                            if (yPos > 240) {
                                doc.addPage();
                                yPos = 15;
                            }
                            
                            // Add Dream Profit Goal section
                            const dpgHeader = document.querySelector('.dream-profit-header');
                            if (dpgHeader) {
                                doc.setFontSize(16);
                                doc.text('Dream Profit Goal', margin, yPos);
                                yPos += 10;
                                
                                // Get header amount
                                const goalAmount = dpgHeader.querySelector('.goal-amount')?.textContent || '';
                                if (goalAmount) {
                                    doc.setFontSize(14);
                                    doc.text(`Annual Goal: ${goalAmount}`, margin, yPos);
                                    yPos += 10;
                                }
                                
                                // Get DPG table data
                                const dpgTableRows = [];
                                const dpgTableHeaders = ['Metric (Required)', 'Day', 'Week', 'Month', 'Year'];
                                
                                // Helper to get table cell content
                                const getTableCellContent = (row, cellIndex) => {
                                    const cell = row.cells[cellIndex];
                                    return cell ? cell.textContent.trim() : '';
                                };
                                
                                // Extract DPG table data
                                const dpgTable = document.querySelector('.dream-profit-table');
                                if (dpgTable && dpgTable.rows.length > 1) {
                                    for (let i = 1; i < dpgTable.rows.length; i++) { // Skip header row
                                        const row = dpgTable.rows[i];
                                        if (row.cells.length >= 5) {
                                            dpgTableRows.push([
                                                getTableCellContent(row, 0),
                                                getTableCellContent(row, 1),
                                                getTableCellContent(row, 2),
                                                getTableCellContent(row, 3),
                                                getTableCellContent(row, 4)
                                            ]);
                                        }
                                    }
                                }
                                
                                // Add DPG table if we have data
                                if (dpgTableRows.length > 0) {
                                    doc.autoTable({
                                        startY: yPos,
                                        head: [dpgTableHeaders],
                                        body: dpgTableRows,
                                        theme: 'striped',
                                        margin: { left: margin, right: margin },
                                        headStyles: { fillColor: [106, 17, 203] }
                                    });
                                    
                                    yPos = doc.lastAutoTable.finalY + 15;
                                }
                            }
                            
                            // Add note and time at the end
                            doc.setFontSize(10);
                            doc.text('Generated with Webinar Hackers Simulator', margin, 285);
                            
                            // Save the PDF
                            doc.save('Webinar_Funnel_Report.pdf');
                            
                            // Reset button
                            pdfBtn.disabled = false;
                            pdfBtn.innerHTML = '<i class="fas fa-file-pdf me-1"></i> PDF';
                            
                        } catch (error) {
                            console.error('Error generating PDF:', error);
                            alert('An error occurred while generating the PDF. Please try again.');
                            pdfBtn.disabled = false;
                            pdfBtn.innerHTML = '<i class="fas fa-file-pdf me-1"></i> PDF';
                        }
                    }
                    
                    // Add required autotable plugin for tables in PDF
                    if (!doc.autoTable) {
                        // Load additional library for tables
                        const script = document.createElement('script');
                        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js';
                        script.onload = function() {
                            captureAndAddContent();
                        };
                        document.head.appendChild(script);
                    } else {
                        captureAndAddContent();
                    }
                });
            }

            // Excel button removed


            // --- Initial Setup ---
            applyDarkModePreference(); // Apply dark mode first
            updateCalculatedVisitors(); // Calc initial visitors display
            renderProductPerformanceTable(null); // Render empty table structure initially
            if (saMetricSelect) highlightSAMetric(saMetricSelect.value); // Highlight initial SA metric
            createCharts(); // Initialize charts with empty/default data and correct theme colors

            // Calculate initial Dream Profit & Sensitivity based on default inputs (will run simulation if lastSimulationResults is null)
            // Ensure the buttons exist before clicking them programmatically
            if (calculateDreamProfitBtn) calculateDreamProfitBtn.click();
            if (analyzeSensitivityBtn) analyzeSensitivityBtn.click();

        }); // End DOMContentLoaded
    </script>

</body>
</html>
